name: 自定义编译配置-矩阵

on:
  schedule:
    - cron: '0 4 * * *'  # 每天UTC时间4点编译
  push:
    branches: [ main ]
    paths:
      - '.github/**'
      - 'configs/**'
      - 'scripts/**'
      - 'feeds.conf'
      - '.config'
  workflow_dispatch:
    inputs:
      target_device:
        description: '选择编译目标设备'
        required: true
        default: 'nanopi-r3s'
        type: choice
        options:
          - nanopi-r3s
          - nanopi-r6s
      include_sfe:
        description: '是否包含Shortcut FE加速'
        type: boolean
        required: false
        default: true
      turboacc_feature:
        description: '选择TurboACC功能配置'
        type: choice
        required: false
        default: 'fullcone-only'
        options:
          - fullcone-only
          - with-sfe

env:
  TIMEOUT: 180m
  GITHUB_TOKEN: ${{ github.token }}

permissions:
  contents: write
  packages: write
  actions: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      build_matrix: ${{ steps.prepare.outputs.build_matrix }}
      cache_key: ${{ steps.prepare.outputs.cache_key }}
    name: 环境准备与配置
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: 生成构建矩阵
        id: prepare
        run: |
          # 根据输入参数生成构建配置
          BUILD_MATRIX=$(cat <<EOF
          [{
            "name": "${{ github.event.inputs.target_device || 'nanopi-r3s' }}",
            "config": "configs/${{ github.event.inputs.target_device || 'nanopi-r3s' }}.config",
            "include_sfe": ${{ github.event.inputs.include_sfe || 'true' }},
            "turboacc_feature": "${{ github.event.inputs.turboacc_feature || 'fullcone-only' }}"
          }]
          EOF
          )
          echo "build_matrix=$BUILD_MATRIX" >> $GITHUB_OUTPUT
          
          # 生成缓存键
          CACHE_KEY="${{ runner.os }}-openwrt-${{ hashFiles('configs/*.config', 'feeds.conf', '.config', 'scripts/*.sh') }}"
          echo "cache_key=$CACHE_KEY" >> $GITHUB_OUTPUT

      - name: 上传准备信息
        uses: actions/upload-artifact@v4
        with:
          name: prepare-info
          path: |
            configs/
            scripts/
            feeds.conf
          retention-days: 1

  setup-environment:
    runs-on: ubuntu-latest
    needs: prepare
    name: 环境设置与依赖安装
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: 设置构建缓存
        uses: actions/cache@v4
        with:
          path: |
            dl
            build_dir
            staging_dir
            tmp
            .config
            .ccache
          key: ${{ needs.prepare.outputs.cache_key }}
          restore-keys: |
            ${{ runner.os }}-openwrt-

      - name: 安装系统依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            flex \
            bison \
            g++ \
            gawk \
            gcc-multilib \
            g++-multilib \
            gettext \
            git \
            libncurses5-dev \
            libssl-dev \
            python3 \
            python3-pip \
            python3-setuptools \
            python3-dev \
            python3-serial \
            unzip \
            zlib1g-dev \
            file \
            wget \
            rsync \
            libelf-dev \
            ccache

      - name: 检查系统信息
        run: |
          echo "=== GitHub Actions 运行器系统信息 ==="
          echo "操作系统: $(lsb_release -d | cut -f2)"
          echo "内核版本: $(uname -r)"
          echo "系统架构: $(uname -m)"
          echo ""
          echo "=== CPU 信息 ==="
          echo "CPU 型号: $(grep 'model name' /proc/cpuinfo | head -1 | cut -d':' -f2 | xargs)"
          echo "CPU 核心数: $(nproc)"
          echo "CPU 线程数: $(grep -c '^processor' /proc/cpuinfo)"
          echo "CPU 频率: $(grep 'cpu MHz' /proc/cpuinfo | head -1 | cut -d':' -f2 | xargs) MHz"
          echo ""
          echo "=== 内存信息 ==="
          free -h
          echo ""
          echo "=== 磁盘信息 ==="
          df -h

      - name: 安装Python依赖
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install pyelftools cffi

  build-toolchain:
    runs-on: ubuntu-latest
    needs: [prepare, setup-environment]
    name: 构建工具链与内核
    strategy:
      matrix: ${{ fromJSON(needs.prepare.outputs.build_matrix) }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: 恢复缓存
        uses: actions/cache@v4
        with:
          path: |
            dl
            build_dir
            staging_dir
            tmp
            .config
            .ccache
          key: ${{ needs.prepare.outputs.cache_key }}
          restore-keys: |
            ${{ runner.os }}-openwrt-

      - name: 应用自定义修改
        run: |
          chmod +x scripts/*.sh
          echo "应用基础补丁..."
          ./scripts/apply-custom-patches.sh
          
          echo "修复 python 依赖..."
          ./scripts/fix-dependencies.sh
          
          echo "集成TurboACC功能..."
          if [ "${{ matrix.turboacc_feature }}" = "with-sfe" ]; then
            echo "包含SFE加速 - 使用官方脚本自动处理依赖"
            curl -sSL https://raw.githubusercontent.com/chenmozhijin/turboacc/luci/add_turboacc.sh | bash
            echo "添加完整的 Shortcut FE 支持..."
            ./scripts/add-shortcut-fe.sh
          else
            echo "仅Fullcone NAT - 使用官方脚本自动处理依赖"  
            curl -sSL https://raw.githubusercontent.com/chenmozhijin/turboacc/luci/add_turboacc.sh | bash -s -- --no-sfe
          fi
          
          echo "添加软件包..."
          ./scripts/add-packages.sh

      - name: 修复已知编译问题
        run: |
          echo "开始修复已知编译问题..."
      
          # 1. 清理真正有问题的包
          echo "清理rtpengine包..."
          rm -rf feeds/telephony/net/rtpengine 2>/dev/null || echo "rtpengine目录不存在"
      
          # 2. 修复Shortcut FE内核兼容性
          echo "修复Shortcut FE内核兼容性..."
          if [ -d "package/qca/shortcut-fe" ]; then
            chmod +x scripts/fix-sfe-kernel-6.12.sh
            ./scripts/fix-sfe-kernel-6.12.sh
          fi

      - name: 更新软件源
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 配置编译参数
        run: |
          cp ${{ matrix.config }} .config
          echo "选择 ${{ matrix.name }} 配置"
          
          # 基础配置
          echo "# CONFIG_PACKAGE_rtpengine is not set" >> .config
          echo "# CONFIG_PACKAGE_freeswitch is not set" >> .config
          echo "# CONFIG_PACKAGE_asterisk is not set" >> .config
          
          # 内核和系统配置
          echo "CONFIG_ALL_KMODS=y" >> .config
          echo "CONFIG_ALL_NONSHARED=n" >> .config
          echo "CONFIG_USE_APK=y" >> .config
          
          # TurboACC配置
          echo "CONFIG_PACKAGE_luci-app-turboacc=m" >> .config
          echo "CONFIG_PACKAGE_nft-fullcone=m" >> .config
          
          if [ "${{ matrix.include_sfe }}" = "true" ] || [ "${{ matrix.turboacc_feature }}" = "with-sfe" ]; then
            echo "启用 Shortcut FE..."
            echo "CONFIG_PACKAGE_kmod-shortcut-fe=m" >> .config
            echo "CONFIG_PACKAGE_kmod-fast-classifier=m" >> .config
          else
            echo "禁用 Shortcut FE..."
            echo "# CONFIG_PACKAGE_kmod-shortcut-fe is not set" >> .config
            echo "# CONFIG_PACKAGE_kmod-fast-classifier is not set" >> .config
          fi
          
          make defconfig

      - name: 构建工具链
        run: |
          echo "开始构建工具链..."
          make toolchain/install -j$(nproc) V=s
          make -j$(nproc) V=s

      - name: 保存工具链缓存
        uses: actions/cache@v4
        with:
          path: |
            dl
            build_dir
            staging_dir
            tmp
            .config
            .ccache
          key: ${{ needs.prepare.outputs.cache_key }}

  build-packages:
    runs-on: ubuntu-latest
    needs: [prepare, build-toolchain]
    name: 构建软件包
    strategy:
      matrix: ${{ fromJSON(needs.prepare.outputs.build_matrix) }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: 恢复缓存
        uses: actions/cache@v4
        with:
          path: |
            dl
            build_dir
            staging_dir
            tmp
            .config
            .ccache
          key: ${{ needs.prepare.outputs.cache_key }}
          restore-keys: |
            ${{ runner.os }}-openwrt-

      - name: 构建软件包
        run: |
          echo "构建选定的软件包..."
          make package/compile -j$(nproc) V=s
          make package/index V=s

      - name: 生成版本信息
        run: |
          echo "=== 固件版本信息 ===" > version-info.txt
          echo "目标设备: ${{ matrix.name }}" >> version-info.txt
          echo "TurboACC功能: ${{ matrix.turboacc_feature }}" >> version-info.txt
          echo "包含SFE: ${{ matrix.include_sfe }}" >> version-info.txt
          echo "编译时间: $(date '+%Y-%m-%d %H:%M:%S')" >> version-info.txt
          echo "Git提交: $(git log -1 --format=%h)" >> version-info.txt

  build-images:
    runs-on: ubuntu-latest
    needs: [prepare, build-toolchain, build-packages]
    name: 构建完整镜像
    strategy:
      matrix: ${{ fromJSON(needs.prepare.outputs.build_matrix) }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: 恢复缓存
        uses: actions/cache@v4
        with:
          path: |
            dl
            build_dir
            staging_dir
            tmp
            .config
            .ccache
          key: ${{ needs.prepare.outputs.cache_key }}
          restore-keys: |
            ${{ runner.os }}-openwrt-

      - name: 构建完整镜像
        run: |
          echo "构建完整固件镜像..."
          make -j$(nproc) V=s 2>&1 | tee build.log
          
          # 如果失败，尝试单线程编译
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "并行编译失败，尝试单线程编译..."
            make -j1 V=s 2>&1 | tee build-retry.log
          fi

      - name: 准备发布文件
        run: |
          mkdir -p release/${{ matrix.name }}
          
          # 复制固件文件
          if [ -d "bin/targets" ]; then
            cp -r bin/targets/* release/${{ matrix.name }}/firmware/
          fi
          
          # 复制软件包
          if [ -d "bin/packages" ]; then
            cp -r bin/packages/* release/${{ matrix.name }}/packages/
          fi
          
          # 复制构建信息
          cp version-info.txt release/${{ matrix.name }}/
          cp .config release/${{ matrix.name }}/ 2>/dev/null || true
          cp build.log release/${{ matrix.name }}/ 2>/dev/null || true
          cp build-retry.log release/${{ matrix.name }}/ 2>/dev/null || true
          
          echo "发布文件准备完成:"
          find release/${{ matrix.name }} -type f | head -20

      - name: 上传固件镜像
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.name }}-${{ matrix.turboacc_feature }}
          path: release/${{ matrix.name }}/firmware/
          retention-days: 30

      - name: 上传软件包
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.name }}
          path: release/${{ matrix.name }}/packages/
          retention-days: 30

      - name: 上传构建信息
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-info-${{ matrix.name }}
          path: release/${{ matrix.name }}/
          retention-days: 7

  finalize:
    runs-on: ubuntu-latest
    needs: [build-images]
    name: 构建完成
    if: always()
    steps:
      - name: 构建状态汇总
        run: |
          echo "=== 构建状态汇总 ==="
          echo "构建任务: ${{ needs.build-images.result }}"
          echo "目标设备: ${{ fromJSON(needs.prepare.outputs.build_matrix)[0].name }}"
          echo "完成时间: $(date '+%Y-%m-%d %H:%M:%S')"
          
          if [ "${{ needs.build-images.result }}" = "success" ]; then
            echo "✅ 所有构建任务完成"
          else
            echo "❌ 部分构建任务失败"
            exit 1
          fi
