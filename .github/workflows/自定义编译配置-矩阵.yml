name: 自定义编译配置-矩阵

on:
  schedule:
    - cron: '0 4 * * *'  # 每天UTC时间4点编译
  push:
    branches: [ main ]
    paths:
      - '.github/**'
      - 'configs/**'
      - 'scripts/**'
      - 'feeds.conf'
      - '.config'
  workflow_dispatch:
    inputs:
      target_device:
        description: '选择编译目标设备'
        required: true
        default: 'nanopi-r3s'
        type: choice
        options:
          - nanopi-r3s
          - nanopi-r6s
      include_sfe:
        description: '是否包含Shortcut FE加速'
        type: boolean
        required: false
        default: true
      turboacc_feature:
        description: '选择TurboACC功能配置'
        type: choice
        required: false
        default: 'fullcone-only'
        options:
          - fullcone-only
          - with-sfe

env:
  TIMEOUT: 180m
  GITHUB_TOKEN: ${{ github.token }}

permissions:
  contents: write
  packages: write
  actions: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      build_matrix: ${{ steps.matrix.outputs.matrix }}
      cache_key: ${{ steps.cache.outputs.cache_key }}
    name: 环境准备与配置
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: 生成构建矩阵
        id: matrix
        run: |
          # 使用简单的矩阵配置
          MATRIX_JSON='[{"name":"nanopi-r3s","config_file":"configs/nanopi-r3s.config","include_sfe":true,"turboacc_feature":"fullcone-only"}]'
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          echo "生成的构建矩阵: $MATRIX_JSON"

      - name: 生成缓存键
        id: cache
        run: |
          CACHE_KEY="${{ runner.os }}-openwrt-${{ github.sha }}"
          echo "cache_key=$CACHE_KEY" >> $GITHUB_OUTPUT
          echo "缓存键: $CACHE_KEY"

  setup-environment:
    runs-on: ubuntu-latest
    needs: prepare
    name: 环境设置与依赖安装
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: 设置构建缓存
        uses: actions/cache@v4
        with:
          path: |
            dl
            build_dir
            staging_dir
            tmp
            .ccache
          key: ${{ needs.prepare.outputs.cache_key }}

      - name: 安装系统依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            flex \
            bison \
            g++ \
            gawk \
            gcc-multilib \
            g++-multilib \
            gettext \
            git \
            libncurses5-dev \
            libssl-dev \
            python3 \
            python3-pip \
            python3-setuptools \
            python3-dev \
            python3-serial \
            unzip \
            zlib1g-dev \
            file \
            wget \
            rsync \
            libelf-dev \
            ccache

      - name: 安装Python依赖
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install pyelftools cffi

  build-openwrt:
    runs-on: ubuntu-latest
    needs: [prepare, setup-environment]
    name: 构建OpenWrt
    strategy:
      matrix:
        config: ${{ fromJSON(needs.prepare.outputs.build_matrix) }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: 恢复缓存
        uses: actions/cache@v4
        with:
          path: |
            dl
            build_dir
            staging_dir
            tmp
            .ccache
          key: ${{ needs.prepare.outputs.cache_key }}

      - name: 显示构建配置
        run: |
          echo "=== 构建配置信息 ==="
          echo "设备名称: ${{ matrix.config.name }}"
          echo "配置文件: ${{ matrix.config.config_file }}"
          echo "包含SFE: ${{ matrix.config.include_sfe }}"
          echo "TurboACC功能: ${{ matrix.config.turboacc_feature }}"

      - name: 应用自定义修改
        run: |
          set -e
          chmod +x scripts/*.sh 2>/dev/null || echo "无脚本文件"
          
          echo "集成TurboACC功能..."
          if [ "${{ matrix.config.turboacc_feature }}" = "with-sfe" ]; then
            echo "包含SFE加速"
            curl -sSL https://raw.githubusercontent.com/chenmozhijin/turboacc/luci/add_turboacc.sh | bash
          else
            echo "仅Fullcone NAT"  
            curl -sSL https://raw.githubusercontent.com/chenmozhijin/turboacc/luci/add_turboacc.sh | bash -s -- --no-sfe
          fi

      - name: 修复已知编译问题
        run: |
          echo "修复已知编译问题..."
          # 清理有问题的包
          rm -rf feeds/telephony/net/rtpengine 2>/dev/null || echo "rtpengine目录不存在"

      - name: 更新软件源
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 配置编译参数
        run: |
          set -e
          # 复制基础配置
          cp ${{ matrix.config.config_file }} .config
          echo "使用配置文件: ${{ matrix.config.config_file }}"
          
          # 基础配置
          cat >> .config << 'EOF'

# 禁用有问题的包
# CONFIG_PACKAGE_rtpengine is not set
# CONFIG_PACKAGE_freeswitch is not set
# CONFIG_PACKAGE_asterisk is not set

# 内核和系统配置
CONFIG_ALL_KMODS=y
CONFIG_ALL_NONSHARED=n
CONFIG_USE_APK=y

# TurboACC配置
CONFIG_PACKAGE_luci-app-turboacc=m
CONFIG_PACKAGE_nft-fullcone=m
EOF

          # SFE配置
          if [ "${{ matrix.config.include_sfe }}" = "true" ] || [ "${{ matrix.config.turboacc_feature }}" = "with-sfe" ]; then
            echo "启用 Shortcut FE..."
            cat >> .config << 'EOF'
CONFIG_PACKAGE_kmod-shortcut-fe=m
CONFIG_PACKAGE_kmod-fast-classifier=m
EOF
          else
            echo "禁用 Shortcut FE..."
            cat >> .config << 'EOF'
# CONFIG_PACKAGE_kmod-shortcut-fe is not set
# CONFIG_PACKAGE_kmod-fast-classifier is not set
EOF
          fi
          
          make defconfig

      - name: 生成版本信息
        run: |
          cat > version-info.txt << 'EOF'
=== 固件版本信息 ===
目标设备: ${{ matrix.config.name }}
TurboACC功能: ${{ matrix.config.turboacc_feature }}
包含SFE: ${{ matrix.config.include_sfe }}
编译时间: $(date '+%Y-%m-%d %H:%M:%S')
Git提交: $(git log -1 --format=%h)
自定义功能: Fullcone NAT + TurboACC
EOF

      - name: 构建固件
        run: |
          set -e
          echo "开始构建固件..."
          
          # 先构建工具链
          echo "构建工具链..."
          make toolchain/install -j$(nproc) V=s
          
          # 构建软件包
          echo "构建软件包..."
          make package/compile -j$(nproc) V=s
          
          # 构建完整镜像
          echo "构建完整镜像..."
          make -j$(nproc) V=s 2>&1 | tee build.log
          
          # 生成包索引
          make package/index

      - name: 准备发布文件
        run: |
          set -e
          RELEASE_DIR="release/${{ matrix.config.name }}"
          mkdir -p $RELEASE_DIR/firmware
          mkdir -p $RELEASE_DIR/packages
          
          # 复制固件
          if [ -d "bin/targets" ]; then
            cp -r bin/targets/* $RELEASE_DIR/firmware/ || echo "固件复制完成"
          fi
          
          # 复制软件包
          if [ -d "bin/packages" ]; then
            cp -r bin/packages/* $RELEASE_DIR/packages/ || echo "软件包复制完成"
          fi
          
          # 复制构建信息
          cp version-info.txt $RELEASE_DIR/
          cp .config $RELEASE_DIR/ 2>/dev/null || true
          cp build.log $RELEASE_DIR/ 2>/dev/null || true
          
          echo "发布文件准备完成"
          find $RELEASE_DIR -type f | head -10

      - name: 上传固件镜像
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.config.name }}-${{ matrix.config.turboacc_feature }}
          path: release/${{ matrix.config.name }}/firmware/
          retention-days: 30

      - name: 上传软件包
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.config.name }}
          path: release/${{ matrix.config.name }}/packages/
          retention-days: 30

      - name: 上传构建信息
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-info-${{ matrix.config.name }}
          path: release/${{ matrix.config.name }}/
          retention-days: 7

  finalize:
    runs-on: ubuntu-latest
    needs: [build-openwrt]
    name: 构建完成
    if: always()
    steps:
      - name: 构建状态汇总
        run: |
          echo "=== 构建状态汇总 ==="
          echo "完成时间: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "GitHub SHA: ${{ github.sha }}"
          
          if [ "${{ needs.build-openwrt.result }}" = "success" ]; then
            echo "✅ 构建任务完成"
          else
            echo "❌ 构建任务失败"
          fi
