name: 自定义编译配置

on:
  schedule:
    - cron: '0 4 * * *'  # 每天UTC时间4点编译
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      target:
        description: 'Build target'
        required: true
        default: 'nanopi-r3s nanopi-r6s'

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [nanopi-r3s, nanopi-r6s]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib \
          g++-multilib gettext git libncurses5-dev libssl-dev python3 python3-pip \
          python3-serial unzip zlib1g-dev file wget

    - name: Apply custom modifications
      run: |
        chmod +x scripts/apply-custom-patches.sh
        chmod +x scripts/add-packages.sh
        ./scripts/apply-custom-patches.sh
        ./scripts/add-packages.sh

    - name: Update feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Configure build
      run: |
        if [ "${{ matrix.target }}" = "nanopi-r3s" ]; then
          cp configs/nanopi-r3s.config .config
        else
          cp configs/nanopi-r6s.config .config
        fi
        make defconfig

    - name: Build firmware
      run: |
        make -j$(nproc) V=s

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-${{ matrix.target }}
        path: bin/targets/
        retention-days: 7
