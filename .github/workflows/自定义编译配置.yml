name: 自定义编译配置

on:
  schedule:
    - cron: '0 4 * * *'  # 每天UTC时间4点编译
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      target_device:  # 目标设备
        description: '选择编译目标设备'
        required: true
        default: 'nanopi-r3s'
        type: choice
        options:
          - nanopi-r3s
          - nanopi-r6s
      include_sfe:  # 包含SFE加速
        description: '是否包含Shortcut FE加速'
        type: boolean
        required: false
        default: false
      turboacc_feature:  # TurboACC功能
        description: '选择TurboACC功能配置'
        type: choice
        required: false
        default: 'fullcone-only'
        options:
          - fullcone-only
          - with-sfe

env:
  TIMEOUT: 180m

jobs:
  build:  # 编译
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3小时超时
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: 设置构建缓存
      uses: actions/cache@v3
      with:
        path: |
          dl
          build_dir
          staging_dir
          tmp
          .config
        key: ${{ runner.os }}-openwrt-${{ hashFiles('configs/*.config', 'feeds.conf', '.config') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-

    - name: 安装系统依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          g++-multilib \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-pip \
          python3-setuptools \
          python3-dev \
          python3-serial \
          unzip \
          zlib1g-dev \
          file \
          wget \
          rsync \
          libelf-dev

    - name: 检查系统信息
      run: |
        echo "=== GitHub Actions 运行器系统信息 ==="
        echo "操作系统: $(lsb_release -d | cut -f2)"
        echo "内核版本: $(uname -r)"
        echo "系统架构: $(uname -m)"
        echo ""
        echo "=== CPU 信息 ==="
        echo "CPU 型号: $(grep 'model name' /proc/cpuinfo | head -1 | cut -d':' -f2 | xargs)"
        echo "CPU 核心数: $(nproc)"
        echo "CPU 线程数: $(grep -c '^processor' /proc/cpuinfo)"
        echo "CPU 频率: $(grep 'cpu MHz' /proc/cpuinfo | head -1 | cut -d':' -f2 | xargs) MHz"
        echo ""
        echo "=== 内存信息 ==="
        free -h
        echo ""
        echo "=== 磁盘信息 ==="
        df -h
        echo ""
        echo "=== 环境信息 ==="
        echo "运行器: ${{ runner.os }}"
        echo "工作目录: ${{ github.workspace }}"
        echo ""

    - name: 安装Python依赖
      run: |
        python3 -m pip install --upgrade pip
        python3 -m pip install pyelftools cffi

    - name: 应用自定义修改
      run: |
        chmod +x scripts/*.sh
        echo "应用基础补丁..."
        ./scripts/apply-custom-patches.sh
        
        echo "修复 python 依赖..."
        ./scripts/fix-dependencies.sh
        
        echo "集成TurboACC功能..."
        if [ "${{ github.event.inputs.turboacc_feature }}" = "with-sfe" ]; then
          echo "包含SFE加速 - 使用官方脚本自动处理依赖"
          curl -sSL https://raw.githubusercontent.com/chenmozhijin/turboacc/luci/add_turboacc.sh | bash
          echo "添加完整的 Shortcut FE 支持..."
          ./scripts/add-shortcut-fe.sh
        else
          echo "仅Fullcone NAT - 使用官方脚本自动处理依赖"  
          curl -sSL https://raw.githubusercontent.com/chenmozhijin/turboacc/luci/add_turboacc.sh | bash -s -- --no-sfe
        fi
        
        echo "添加软件包..."
        ./scripts/add-packages.sh

    - name: 检查编译环境
      run: |
        echo "检查关键包状态..."
        # 检查 libnftnl
        if [ -d "package/libs/libnftnl" ]; then
            echo "✅ libnftnl 存在"
            ls package/libs/libnftnl/patches/ 2>/dev/null || echo "无补丁"
        else
            echo "❌ libnftnl 不存在"
        fi
        
        # 检查 shortcut-fe
        if [ -f "package/network/shortcut-fe/Makefile" ]; then
            echo "✅ shortcut-fe 存在"
        else
            echo "⚠️ shortcut-fe 不存在"
        fi

    - name: 更新软件源
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 配置编译参数
      run: |
        if [ "${{ github.event.inputs.target_device }}" = "nanopi-r3s" ]; then
          cp configs/nanopi-r3s.config .config
          echo "选择NanoPi R3S配置"
        else
          cp configs/nanopi-r6s.config .config
          echo "选择NanoPi R6S配置"
        fi
        
        # 内核模块配置 - 启用所有kmods
        echo "CONFIG_ALL_KMODS=y" >> .config
        echo "CONFIG_ALL_NONSHARED=n" >> .config
        
        # 启用APK包管理
        echo "CONFIG_USE_APK=y" >> .config
        
        # 修复 Python 依赖警告
        echo "CONFIG_PACKAGE_python3-distutils=m" >> .config
        
        # 基础系统 - 最小化内置
        echo "CONFIG_PACKAGE_luci=m" >> .config
        echo "CONFIG_PACKAGE_luci-base=m" >> .config
        echo "CONFIG_PACKAGE_luci-compat=m" >> .config
        echo "CONFIG_PACKAGE_luci-theme-bootstrap=m" >> .config
        echo "CONFIG_LUCI_LANG_zh-cn=m" >> .config
        
        # 基础网络工具 - 模块化
        echo "CONFIG_PACKAGE_iptables=m" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-conntrack-extra=m" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-ipopt=m" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-nat-extra=m" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-tproxy=m" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-extra=m" >> .config
        echo "CONFIG_PACKAGE_ip6tables=m" >> .config
        echo "CONFIG_PACKAGE_ip6tables-mod-nat=m" >> .config
        
        # 防火墙 - 模块化
        echo "CONFIG_PACKAGE_firewall=m" >> .config
        echo "CONFIG_PACKAGE_firewall4=m" >> .config
        
        # TurboACC核心功能 - 模块化
        echo "CONFIG_PACKAGE_luci-app-turboacc=m" >> .config
        echo "CONFIG_PACKAGE_nft-fullcone=m" >> .config
        
        # 根据参数调整配置
        if [ "${{ github.event.inputs.include_sfe }}" = "true" ] || [ "${{ github.event.inputs.turboacc_feature }}" = "with-sfe" ]; then
          echo "启用完整的 Shortcut FE..."
          echo "CONFIG_PACKAGE_kmod-shortcut-fe=m" >> .config
          echo "CONFIG_PACKAGE_kmod-shortcut-fe-cm=m" >> .config
          echo "CONFIG_PACKAGE_kmod-fast-classifier=m" >> .config
        fi
        
        # 系统工具 - 模块化
        echo "CONFIG_PACKAGE_curl=m" >> .config
        echo "CONFIG_PACKAGE_bash=m" >> .config
        echo "CONFIG_PACKAGE_htop=m" >> .config
        echo "CONFIG_PACKAGE_nano=m" >> .config
        echo "CONFIG_PACKAGE_vim=m" >> .config
        echo "CONFIG_PACKAGE_git=m" >> .config
        echo "CONFIG_PACKAGE_git-http=m" >> .config
        
        # 网络诊断工具 - 模块化
        echo "CONFIG_PACKAGE_iperf3=m" >> .config
        echo "CONFIG_PACKAGE_tcpdump=m" >> .config
        echo "CONFIG_PACKAGE_curl=m" >> .config
        echo "CONFIG_PACKAGE_wget=m" >> .config
        echo "CONFIG_PACKAGE_iputils-ping=m" >> .config
        echo "CONFIG_PACKAGE_iputils-traceroute=m" >> .config
        
        # routing 相关包 - 模块化
        echo "CONFIG_PACKAGE_batman-adv=m" >> .config
        echo "CONFIG_PACKAGE_quagga=m" >> .config
        echo "CONFIG_PACKAGE_babeld=m" >> .config
        echo "CONFIG_PACKAGE_olsrd=m" >> .config
        echo "CONFIG_PACKAGE_bmxd=m" >> .config
        
        # 无线驱动 - 模块化
        echo "CONFIG_PACKAGE_kmod-mt76=m" >> .config
        echo "CONFIG_PACKAGE_kmod-mt76x2u=m" >> .config
        echo "CONFIG_PACKAGE_kmod-mt7603=m" >> .config
        echo "CONFIG_PACKAGE_kmod-mt7615e=m" >> .config
        echo "CONFIG_PACKAGE_kmod-mt7615-firmware=m" >> .config
        
        # 虚拟化支持 - 模块化
        echo "CONFIG_PACKAGE_kmod-kvm=m" >> .config
        echo "CONFIG_PACKAGE_kmod-tun=m" >> .config
        echo "CONFIG_PACKAGE_kmod-veth=m" >> .config
        
        # 文件系统支持 - 模块化
        echo "CONFIG_PACKAGE_kmod-fs-9p=m" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-autofs4=m" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-btrfs=m" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-cifs=m" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-exfat=m" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-ext4=m" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-f2fs=m" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-nfs=m" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-nfs-common=m" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-nfsd=m" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-ntfs=m" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-squashfs=m" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-xfs=m" >> .config
        
        # USB 支持 - 模块化
        echo "CONFIG_PACKAGE_kmod-usb-core=m" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-ohci=m" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-uhci=m" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-storage=m" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-storage-uas=m" >> .config
        echo "CONFIG_PACKAGE_kmod-usb2=m" >> .config
        echo "CONFIG_PACKAGE_kmod-usb3=m" >> .config
        
        # 仅内置最基础的系统组件
        echo "CONFIG_PACKAGE_base-files=y" >> .config
        echo "CONFIG_PACKAGE_busybox=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq=y" >> .config
        echo "CONFIG_PACKAGE_dropbear=y" >> .config
        echo "CONFIG_PACKAGE_opkg=y" >> .config
        echo "CONFIG_PACKAGE_procd=y" >> .config
        echo "CONFIG_PACKAGE_uci=y" >> .config
        echo "CONFIG_PACKAGE_urandom-seed=y" >> .config
        
        make defconfig

    - name: 生成版本信息
      run: |
        echo "=== 固件版本信息 ===" > version-info.txt
        echo "基础版本: OpenWrt SNAPSHOT (开发版)" >> version-info.txt
        echo "内核版本: 6.12" >> version-info.txt
        echo "包管理器: apk" >> version-info.txt
        echo "编译时间: $(date '+%Y-%m-%d %H:%M:%S')" >> version-info.txt
        echo "目标设备: ${{ github.event.inputs.target_device }}" >> version-info.txt
        echo "TurboACC功能: ${{ github.event.inputs.turboacc_feature }}" >> version-info.txt
        echo "包含SFE: ${{ github.event.inputs.include_sfe }}" >> version-info.txt
        echo "Git提交: $(git log -1 --format=%h)" >> version-info.txt
        echo "自定义功能: Fullcone NAT + TurboACC" >> version-info.txt
        echo "编译策略: 全kmods + 模块化插件" >> version-info.txt
        cat version-info.txt

    - name: 构建固件（充分利用硬件）
      run: |
        echo "=== 高性能编译配置 ==="
        echo "硬件: 4核心 AMD EPYC + 15GB 内存"
        
        # 创建构建日志目录
        mkdir -p logs
        
        # 分阶段优化配置
        {
            echo "阶段1: 下载软件包 (4线程)"
            make download -j4
            
            echo "阶段2: 编译工具链 (3线程)"
            make toolchain/compile -j3
            make toolchain/install -j3
            
            echo "阶段3: 编译内核模块 (3线程)"
            make target/linux/compile -j3
            
            echo "阶段4: 编译软件包 (3线程)"
            make package/compile -j3
            
            echo "阶段5: 生成固件镜像 (2线程)"
            make -j2 V=s
        } 2>&1 | tee logs/build-optimized.log
        
        echo "✅ 编译完成！资源利用率最大化"

    - name: 生成软件包索引
      run: |
        echo "生成APK软件包索引..."
        make package/index

    - name: 准备上传文件
      run: |
        # 创建上传目录
        mkdir -p upload/firmware
        mkdir -p upload/packages
        mkdir -p upload/logs
        
        # 复制固件文件
        if [ -d "bin/targets" ]; then
          cp -r bin/targets/* upload/firmware/ || echo "固件目录复制失败"
        fi
        
        # 复制软件包
        if [ -d "bin/packages" ]; then
          cp -r bin/packages/* upload/packages/ || echo "软件包目录复制失败"
        fi
        
        # 复制日志和配置文件
        cp version-info.txt upload/
        cp .config upload/ 2>/dev/null || echo ".config 不存在"
        cp logs/build-optimized.log upload/logs/ 2>/dev/null || echo "构建日志不存在"
        
        # 检查文件是否存在
        echo "=== 准备上传的文件 ==="
        find upload/ -type f | head -20

    - name: 上传固件镜像
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.target_device }}-${{ github.event.inputs.turboacc_feature }}
        path: upload/firmware/
        retention-days: 30

    - name: 上传软件包
      uses: actions/upload-artifact@v4
      with:
        name: packages-${{ github.event.inputs.target_device }}
        path: upload/packages/
        retention-days: 30

    - name: 上传构建日志和配置
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-info-${{ github.event.inputs.target_device }}
        path: upload/
        retention-days: 7
