name: 自定义编译配置

on:
  schedule:
    - cron: '0 4 * * *'  # 每天UTC时间4点编译
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      target_device:  # 目标设备
        description: '选择编译目标设备'
        required: true
        default: 'nanopi-r3s'
        type: choice
        options:
          - nanopi-r3s
          - nanopi-r6s
      include_sfe:  # 包含SFE加速
        description: '是否包含Shortcut FE加速'
        type: boolean
        required: false
        default: true
      compile_threads:  # 编译线程数
        description: '选择编译线程数 (单线程更稳定，多线程更快)'
        required: false
        default: 'single'
        type: choice
        options:
          - single
          - multi
      build_mode:  # 编译模式
        description: '选择编译模式 (firmware=全kmods+固件, full=全kmods+固件+全插件)'
        required: false
        default: 'firmware'
        type: choice
        options:
          - firmware
          - full
      include_istore:  # 包含iStore
        description: '是否包含iStore相关功能'
        type: boolean
        required: false
        default: true

env:
  TIMEOUT: 360m

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: 设置构建缓存
      uses: actions/cache@v3
      with:
        path: |
          dl
          build_dir
          staging_dir
          tmp
          .config
          feeds
        key: ${{ runner.os }}-openwrt-${{ hashFiles('configs/*.config', 'feeds.conf', '.config') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-

    - name: 安装系统依赖 (LEDE推荐)
      run: |
        echo "=== 安装LEDE推荐的完整编译依赖 ==="
        sudo apt update -y
        sudo apt full-upgrade -y
        sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext \
        genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
        libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
        libreadline-dev libssl-dev libtool llvm lrzsz libnsl-dev ninja-build p7zip p7zip-full patch pkgconf \
        python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
        swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev

    - name: 检查系统信息
      run: |
        echo "=== 环境信息 ==="
        echo "设备: ${{ github.event.inputs.target_device }}"
        echo "线程: ${{ github.event.inputs.compile_threads }}"
        echo "模式: ${{ github.event.inputs.build_mode }}"
        echo "iStore: ${{ github.event.inputs.include_istore }}"
        echo "SFE: ${{ github.event.inputs.include_sfe }}"
        echo "CPU: $(nproc) 核心"
        echo "内存: $(free -h | grep Mem | awk '{print $2}')"
        echo "系统: $(lsb_release -d | cut -f2)"
        echo ""

    - name: 配置 feeds 源
      run: |
        echo "配置 feeds 源..."
        cat > feeds.conf << 'EOF'
        src-git packages https://github.com/openwrt/packages.git
        src-git luci https://github.com/openwrt/luci.git
        src-git routing https://github.com/openwrt/routing.git
        src-git telephony https://github.com/openwrt/telephony.git
        EOF

    - name: 更新和安装 feeds
      run: |
        echo "更新 feeds..."
        ./scripts/feeds update -a
        echo "安装 feeds..."
        ./scripts/feeds install -a

    - name: 下载并应用 Fullcone NAT 补丁
      run: |
        echo "=== 下载并应用 Fullcone NAT 补丁 ==="
        
        # 创建补丁目录
        mkdir -p target/linux/generic/hack-6.12
        mkdir -p package/libs/libnftnl/patches
        mkdir -p package/network/utils/nftables/patches
        mkdir -p package/network/config/firewall4/patches
        mkdir -p package/network/config/firewall/patches
        mkdir -p package/network/utils/iptables/patches
        mkdir -p package/base-files/files/etc/uci-defaults
        
        # 1. 下载内核 Fullcone NAT 补丁 (从 LEDE)
        echo "下载内核 Fullcone NAT 补丁..."
        curl -sSL https://raw.githubusercontent.com/coolsnowwolf/lede/master/target/linux/generic/hack-6.12/982-add-bcm-fullconenat-support.patch \
          -o target/linux/generic/hack-6.12/982-add-bcm-fullconenat-support.patch || echo "内核补丁下载失败"
        
        # 2. 下载 libnftnl Fullcone 支持补丁 (从 iStoreOS)
        echo "下载 libnftnl Fullcone 支持补丁..."
        curl -sSL https://raw.githubusercontent.com/istoreos/istoreos/istoreos-24.10/package/libs/libnftnl/patches/999-11-masq-fullcone-expr.patch \
          -o package/libs/libnftnl/patches/999-11-masq-fullcone-expr.patch || echo "libnftnl 补丁下载失败"
        
        # 3. 下载 nftables Fullcone 支持补丁 (从 iStoreOS)
        echo "下载 nftables Fullcone 支持补丁..."
        curl -sSL https://raw.githubusercontent.com/istoreos/istoreos/istoreos-24.10/package/network/utils/nftables/patches/999-11-masq-fullcone-flag.patch \
          -o package/network/utils/nftables/patches/999-11-masq-fullcone-flag.patch || echo "nftables 补丁下载失败"
        
        # 4. 下载 firewall4 Fullcone 支持补丁 (从 iStoreOS)
        echo "下载 firewall4 Fullcone 支持补丁..."
        curl -sSL https://raw.githubusercontent.com/istoreos/istoreos/istoreos-24.10/package/network/config/firewall4/patches/999-03-fw4-masq-fullcone.patch \
          -o package/network/config/firewall4/patches/999-03-fw4-masq-fullcone.patch || echo "firewall4 补丁下载失败"
        
        # 5. 下载 iptables Fullcone 支持补丁 (从 iStoreOS)
        echo "下载 iptables Fullcone 支持补丁..."
        curl -sSL https://raw.githubusercontent.com/istoreos/istoreos/istoreos-24.10/package/network/utils/iptables/patches/900-bcm-fullconenat.patch \
          -o package/network/utils/iptables/patches/900-bcm-fullconenat.patch || echo "iptables 补丁下载失败"
        
        # 6. 下载配置脚本 (从 iStoreOS)
        echo "下载 Fullcone NAT 配置脚本..."
        curl -sSL https://raw.githubusercontent.com/istoreos/istoreos/istoreos-24.10/package/istoreos-files/files/etc/uci-defaults/99_fullcone_nat_fw4 \
          -o package/base-files/files/etc/uci-defaults/99_fullcone_nat_fw4 || echo "配置脚本下载失败"
        
        chmod +x package/base-files/files/etc/uci-defaults/99_fullcone_nat_fw4
        
        echo "✅ Fullcone NAT 补丁下载完成"
        
        # 验证下载的文件
        echo "=== 验证下载的补丁 ==="
        find . -name "*fullcone*" -o -name "*masq*" -type f 2>/dev/null | head -20

    - name: 运行 prereq 检查
      run: |
        echo "=== 运行 prereq 依赖检查 ==="
        make prereq
        echo "✅ prereq 检查通过"

    - name: 应用基础配置
      run: |
        echo "=== 应用基础设备配置 ==="
        if [ "${{ github.event.inputs.target_device }}" = "nanopi-r3s" ]; then
          cp configs/nanopi-r3s.config .config
          echo "选择 NanoPi R3S 配置"
        else
          cp configs/nanopi-r6s.config .config
          echo "选择 NanoPi R6S 配置"
        fi
        
        # 应用基础配置
        make defconfig
        echo "✅ 基础配置完成"

    - name: 配置核心功能（修正版）
      run: |
        echo "=== 配置核心功能（修正 Fullcone NAT 配置）==="
        
        # 启用全内核模块
        echo "CONFIG_ALL_KMODS=y" >> .config
        
        # 基础系统配置
        echo "CONFIG_USE_APK=y" >> .config
        
        # 禁用有问题的包
        echo "# CONFIG_PACKAGE_rtpengine is not set" >> .config
        echo "# CONFIG_PACKAGE_freeswitch is not set" >> .config
        echo "# CONFIG_PACKAGE_asterisk is not set" >> .config
        
        # Fullcone NAT - 通过补丁实现，只需要启用基础包
        echo "CONFIG_PACKAGE_firewall4=y" >> .config
        echo "CONFIG_PACKAGE_nftables-json=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-extra=y" >> .config
        
        # Shortcut FE配置
        if [ "${{ github.event.inputs.include_sfe }}" = "true" ]; then
          echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
          echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
          echo "CONFIG_PACKAGE_kmod-shortcut-fe-drv=y" >> .config
        fi
        
        # 根据编译模式配置
        if [ "${{ github.event.inputs.build_mode }}" = "full" ]; then
          echo "CONFIG_PACKAGE_bash=y" >> .config
          echo "CONFIG_PACKAGE_htop=y" >> .config
          echo "CONFIG_PACKAGE_nano=y" >> .config
          echo "CONFIG_PACKAGE_vim=y" >> .config
          echo "CONFIG_PACKAGE_curl=y" >> .config
        fi
        
        # iStore配置
        if [ "${{ github.event.inputs.include_istore }}" = "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-istorex=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-store=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-quickstart=y" >> .config
        fi
        
        # 重新应用配置
        make defconfig
        echo "✅ 核心功能配置完成"

    - name: 启用必需的内核模块
      run: |
        echo "=== 启用必需的内核模块 ==="
        
        # 网络核心模块
        echo "CONFIG_PACKAGE_kmod-ppp=y" >> .config
        echo "CONFIG_PACKAGE_kmod-pppoe=y" >> .config
        echo "CONFIG_PACKAGE_kmod-nf-nat=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipv6=y" >> .config
        
        # 文件系统
        echo "CONFIG_PACKAGE_kmod-fs-ext4=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-squashfs=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-vfat=y" >> .config
        
        # USB支持
        echo "CONFIG_PACKAGE_kmod-usb-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-storage=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
        
        # 加密
        echo "CONFIG_PACKAGE_kmod-crypto-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-crypto-hash=y" >> .config
        
        # 其他核心模块
        echo "CONFIG_PACKAGE_kmod-nls-base=y" >> .config
        echo "CONFIG_PACKAGE_kmod-nls-utf8=y" >> .config
        
        # 应用配置
        make oldconfig
        echo "✅ 内核模块配置完成"

    - name: 验证 Fullcone NAT 配置（修正版）
      run: |
        echo "=== 验证 Fullcone NAT 配置 ==="
        
        echo "Fullcone NAT 补丁状态:"
        if [ -f "target/linux/generic/hack-6.12/982-add-bcm-fullconenat-support.patch" ]; then
          echo "✅ 内核 Fullcone NAT 补丁已应用"
        else
          echo "❌ 内核 Fullcone NAT 补丁缺失"
        fi
        
        if [ -f "package/libs/libnftnl/patches/999-11-masq-fullcone-expr.patch" ]; then
          echo "✅ libnftnl Fullcone 支持已添加"
        else
          echo "❌ libnftnl Fullcone 支持缺失"
        fi
        
        if [ -f "package/network/utils/nftables/patches/999-11-masq-fullcone-flag.patch" ]; then
          echo "✅ nftables Fullcone 支持已添加"
        else
          echo "❌ nftables Fullcone 支持缺失"
        fi
        
        if [ -f "package/network/config/firewall4/patches/999-03-fw4-masq-fullcone.patch" ]; then
          echo "✅ firewall4 Fullcone 支持已添加"
        else
          echo "❌ firewall4 Fullcone 支持缺失"
        fi
        
        echo ""
        echo "实际配置状态:"
        echo "防火墙方案: $(grep "CONFIG_PACKAGE_firewall" .config | head -1 || echo "未配置")"
        echo "nftables: $(grep "CONFIG_PACKAGE_nftables" .config | head -1 || echo "未配置")"
        echo "iptables: $(grep "CONFIG_PACKAGE_iptables" .config | head -1 || echo "未配置")"
        
        echo ""
        echo "核心功能状态:"
        echo "✅ 全内核模块"
        echo "✅ Fullcone NAT 支持（通过补丁）"
        echo "✅ 基础网络功能"
        
        if [ "${{ github.event.inputs.include_sfe }}" = "true" ]; then
          echo "✅ Shortcut FE 加速"
        else
          echo "⚠️ 无 Shortcut FE 加速"
        fi
        
        if [ "${{ github.event.inputs.include_istore }}" = "true" ]; then
          echo "✅ iStore 应用商店"
        else
          echo "⚠️ 无 iStore"
        fi

    - name: 修复常见问题
      run: |
        echo "=== 修复常见编译问题 ==="
        
        # 清理有问题的包
        rm -rf feeds/telephony/net/rtpengine 2>/dev/null || true
        
        # 修复可能的依赖问题
        if [ -d "package/qca/shortcut-fe" ]; then
          echo "修复 Shortcut FE 配置..."
          find package/qca/shortcut-fe -name "*.mk" -exec sed -i 's/kmod-shortcut-fe-cm/kmod-shortcut-fe/g' {} \; 2>/dev/null || true
        fi

    - name: 生成版本信息
      run: |
        echo "=== 生成版本信息 ==="
        {
          echo "固件版本: OpenWrt SNAPSHOT (完整 Fullcone NAT 支持)"
          echo "内核版本: 6.12"
          echo "编译时间: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "目标设备: ${{ github.event.inputs.target_device }}"
          echo "编译模式: ${{ github.event.inputs.build_mode }}"
          echo "包含功能:"
          echo "  - 全内核模块"
          echo "  - 完整 Fullcone NAT 支持"
          echo "  - firewall4 + nftables"
          
          if [ "${{ github.event.inputs.include_sfe }}" = "true" ]; then
            echo "  - Shortcut FE 加速"
          else
            echo "  - 无 SFE 加速"
          fi
          
          if [ "${{ github.event.inputs.include_istore }}" = "true" ]; then
            echo "  - iStore 应用商店"
          else
            echo "  - 无 iStore"
          fi
          
          echo "Git提交: $(git log -1 --format=%h)"
          echo ""
          echo "Fullcone NAT 特性:"
          echo "  - BCM Fullcone NAT 内核补丁"
          echo "  - libnftnl Fullcone 表达式支持"
          echo "  - nftables Fullcone 标志支持"
          echo "  - firewall4 Fullcone 配置支持"
          echo "  - 自动 Fullcone NAT 配置脚本"
        } > version-info.txt
        
        cat version-info.txt

    - name: 编译固件
      run: |
        echo "=== 开始编译（完整 Fullcone NAT 支持）==="
        
        # 设置线程数
        if [ "${{ github.event.inputs.compile_threads }}" = "multi" ]; then
          THREADS=$(nproc)
          echo "使用多线程模式: $THREADS 个CPU核心"
        else
          THREADS=1
          echo "使用单线程模式: 1 个CPU核心 (系统有 $(nproc) 个核心)"
        fi
        
        # 设置环境变量
        export FORCE_UNSAFE_CONFIGURE=1
        
        echo "开始完整编译..."
        set +e  # 禁用错误退出
        if [ "$THREADS" -eq 1 ]; then
          make -j1 V=s 2>&1 | tee build.log
          COMPILE_RESULT=${PIPESTATUS[0]}
        else
          make -j$THREADS V=s 2>&1 | tee build.log
          COMPILE_RESULT=${PIPESTATUS[0]}
        fi
        set -e  # 重新启用错误退出
        
        # 检查编译结果
        if [ -d "bin/targets" ] && [ $(find bin/targets/ -name "*.bin" -o -name "*.img" 2>/dev/null | wc -l) -gt 0 ]; then
          echo "✅ 固件文件已生成，编译成功"
          exit 0
        elif [ -d "bin/packages" ] && [ $(find bin/packages/ -name "*.ipk" 2>/dev/null | wc -l) -gt 0 ]; then
          echo "⚠️ 只有软件包生成，编译部分成功"
          exit 0
        elif [ $COMPILE_RESULT -eq 0 ]; then
          echo "✅ 编译过程完成（无错误）"
          exit 0
        else
          echo "❌ 编译失败"
          exit $COMPILE_RESULT
        fi

    - name: 收集构建产物
      if: always()
      run: |
        echo "=== 收集构建产物 ==="
        mkdir -p upload/firmware upload/packages upload/logs
        
        # 收集固件
        find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \) -exec cp --parents {} upload/firmware/ \; 2>/dev/null || true
        
        # 收集软件包
        if [ -d "bin/packages" ]; then
          cp -r bin/packages/* upload/packages/ 2>/dev/null || true
        fi
        
        # 收集日志和配置
        cp version-info.txt upload/ 2>/dev/null || true
        cp .config upload/ 2>/dev/null || true
        cp build.log upload/logs/ 2>/dev/null || true
        
        echo "产物统计:"
        echo "固件文件: $(find upload/firmware -type f 2>/dev/null | wc -l || echo 0) 个"
        echo "软件包: $(find upload/packages -name "*.ipk" 2>/dev/null | wc -l || echo 0) 个"
        find upload/firmware -type f 2>/dev/null | head -10 || echo "无固件文件"

    - name: 上传固件
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.target_device }}-${{ github.event.inputs.build_mode }}
        path: upload/firmware/
        retention-days: 30
        if-no-files-found: warn

    - name: 上传软件包
      uses: actions/upload-artifact@v4
      with:
        name: packages-${{ github.event.inputs.target_device }}-${{ github.event.inputs.build_mode }}
        path: upload/packages/
        retention-days: 30
        if-no-files-found: warn

    - name: 上传构建信息
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-info-${{ github.event.inputs.target_device }}-${{ github.event.inputs.build_mode }}
        path: upload/
        retention-days: 7
        if-no-files-found: warn
