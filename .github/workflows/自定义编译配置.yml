name: 自定义编译配置（优化磁盘空间版）

on:
  schedule:
    - cron: '0 4 * * *'
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      target_device:
        description: '选择编译目标设备'
        required: true
        default: 'nanopi-r3s'
        type: choice
        options:
          - nanopi-r3s
          - nanopi-r6s
      include_sfe:
        description: '是否包含Shortcut FE加速'
        type: boolean
        required: false
        default: true
      compile_threads:
        description: '选择编译线程数'
        required: false
        default: 'single'
        type: choice
        options:
          - single
          - multi
      build_mode:
        description: '选择编译模式 (精简版节省空间)'
        required: false
        default: 'firmware'
        type: choice
        options:
          - firmware
          - full
      include_istore:
        description: '是否包含iStore相关功能'
        type: boolean
        required: false
        default: false  # 默认关闭以节省空间
      turboacc_method:
        description: '选择TurboACC加速方案'
        required: false
        default: 'immortalwrt'
        type: choice
        options:
          - immortalwrt
          - script

env:
  TIMEOUT: 360m

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 1  # 浅克隆节省空间

    - name: 初始磁盘空间检查
      run: |
        echo "=== 初始磁盘空间 ==="
        df -h
        echo "=== 内存使用 ==="
        free -h

    - name: 设置构建缓存（优化版）
      uses: actions/cache@v3
      with:
        path: |
          dl
          build_dir/target-*/toolchain-*
          staging_dir/toolchain-*
        key: ${{ runner.os }}-openwrt-${{ hashFiles('configs/*.config', 'feeds.conf') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-

    - name: 安装系统依赖（完整版）
      run: bash scripts/install-dependencies.sh full

    - name: 配置 feeds
      run: |
        cat > feeds.conf << 'EOF'
        src-git packages https://github.com/openwrt/packages.git
        src-git luci https://github.com/openwrt/luci.git
        src-git routing https://github.com/openwrt/routing.git
        EOF
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 修复 nftables 问题
      run: bash scripts/fix-nftables-issue.sh ${{ github.event.inputs.turboacc_method }}

    - name: 应用 TurboACC 方案
      run: bash scripts/apply-turboacc.sh ${{ github.event.inputs.turboacc_method }} ${{ github.event.inputs.include_sfe }}

    - name: 运行 prereq 检查
      run: make prereq

    - name: 应用基础配置
      run: |
        if [ "${{ github.event.inputs.target_device }}" = "nanopi-r3s" ]; then
          cp configs/nanopi-r3s.config .config
        else
          cp configs/nanopi-r6s.config .config
        fi
        make defconfig

    - name: 配置防火墙功能
      run: bash scripts/configure-firewall.sh ${{ github.event.inputs.turboacc_method }} ${{ github.event.inputs.include_sfe }} ${{ github.event.inputs.build_mode }} ${{ github.event.inputs.include_istore }}

    - name: 优化构建配置（节省空间）
      run: bash scripts/optimize-build.sh ${{ github.event.inputs.build_mode }} ${{ github.event.inputs.include_istore }}

    - name: 编译前磁盘清理
      run: bash scripts/clean-disk-space.sh

    - name: 编译固件（优化版）
      run: |
        echo "=== 编译前磁盘空间 ==="
        df -h
        
        # 设置编译环境
        export FORCE_UNSAFE_CONFIGURE=1
        
        # 根据线程数编译
        if [ "${{ github.event.inputs.compile_threads }}" = "multi" ]; then
          THREADS=$(($(nproc) - 1))  # 留一个核心给系统
        else
          THREADS=1
        fi
        
        echo "使用 $THREADS 个线程编译"
        
        # 编译（减少详细输出以节省日志空间）
        make -j$THREADS V=sc 2>&1 | tee build.log | grep -E "(error|warning|Error|Warning)" || true
        
        echo "=== 编译后磁盘空间 ==="
        df -h

    - name: 编译后磁盘清理
      if: always()
      run: |
        echo "=== 最终磁盘空间清理 ==="
        bash scripts/clean-disk-space.sh

    - name: 收集产物（最小化）
      if: always()
      run: |
        mkdir -p upload/firmware
        # 只收集最终的固件文件
        find bin/targets -name "*-sysupgrade.bin" -o -name "*.img.gz" -o -name "*.img" | head -5 | xargs -I {} cp {} upload/firmware/ 2>/dev/null || true
        echo "收集的固件:"
        ls -la upload/firmware/ || echo "无固件文件"

    - name: 上传固件
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.target_device }}-${{ github.event.inputs.turboacc_method }}
        path: upload/firmware/
        retention-days: 7
        if-no-files-found: warn
