name: 自定义编译配置

on:
  schedule:
    - cron: '0 4 * * *'
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      target_device:
        description: '选择编译目标设备'
        required: true
        default: 'nanopi-r3s'
        type: choice
        options:
          - nanopi-r3s
          - nanopi-r6s
      include_sfe:
        description: '是否包含Shortcut FE加速'
        type: boolean
        required: false
        default: true
      compile_threads:
        description: '选择编译线程数'
        required: false
        default: 'single'
        type: choice
        options:
          - single
          - multi
      build_mode:
        description: '选择编译模式'
        required: false
        default: 'firmware'
        type: choice
        options:
          - firmware
          - full
      include_istore:
        description: '是否包含iStore相关功能'
        type: boolean
        required: false
        default: true
      turboacc_method:
        description: '选择TurboACC加速方案'
        required: false
        default: 'immortalwrt'
        type: choice
        options:
          - immortalwrt
          - script

env:
  TIMEOUT: 360m

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: 设置构建缓存
      uses: actions/cache@v3
      with:
        path: |
          dl
          build_dir
          staging_dir
          tmp
          .config
          feeds
        key: ${{ runner.os }}-openwrt-${{ hashFiles('configs/*.config', 'feeds.conf', '.config') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-

    - name: 安装系统依赖
      run: |
        sudo apt update -y
        sudo apt full-upgrade -y
        sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool llvm lrzsz libnsl-dev ninja-build p7zip p7zip-full patch pkgconf python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev

    - name: 配置环境
      run: |
        echo "设备: ${{ github.event.inputs.target_device }}"
        echo "线程: ${{ github.event.inputs.compile_threads }}"
        echo "TurboACC方案: ${{ github.event.inputs.turboacc_method }}"
        nproc

    - name: 配置 feeds
      run: |
        cat > feeds.conf << 'EOF'
        src-git packages https://github.com/openwrt/packages.git
        src-git luci https://github.com/openwrt/luci.git
        src-git routing https://github.com/openwrt/routing.git
        src-git telephony https://github.com/openwrt/telephony.git
        EOF
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 修复 nftables 问题
      run: bash scripts/fix-nftables-issue.sh ${{ github.event.inputs.turboacc_method }}

    - name: 应用 TurboACC 方案
      run: bash scripts/apply-turboacc.sh ${{ github.event.inputs.turboacc_method }} ${{ github.event.inputs.include_sfe }}

    - name: 运行 prereq 检查
      run: make prereq

    - name: 应用基础配置
      run: |
        if [ "${{ github.event.inputs.target_device }}" = "nanopi-r3s" ]; then
          cp configs/nanopi-r3s.config .config
        else
          cp configs/nanopi-r6s.config .config
        fi
        make defconfig

    - name: 配置防火墙功能
      run: bash scripts/configure-firewall.sh ${{ github.event.inputs.turboacc_method }} ${{ github.event.inputs.include_sfe }} ${{ github.event.inputs.build_mode }} ${{ github.event.inputs.include_istore }}

    - name: 编译固件
      run: |
        if [ "${{ github.event.inputs.compile_threads }}" = "multi" ]; then
          THREADS=$(nproc)
        else
          THREADS=1
        fi
        export FORCE_UNSAFE_CONFIGURE=1
        make -j$THREADS V=s

    - name: 收集产物
      if: always()
      run: |
        mkdir -p upload/firmware upload/packages
        find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \) -exec cp --parents {} upload/firmware/ \; 2>/dev/null || true
        [ -d "bin/packages" ] && cp -r bin/packages/* upload/packages/ 2>/dev/null || true

    - name: 上传固件
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.target_device }}-${{ github.event.inputs.turboacc_method }}
        path: upload/firmware/
        if-no-files-found: warn

    - name: 上传软件包
      uses: actions/upload-artifact@v4
      with:
        name: packages-${{ github.event.inputs.target_device }}-${{ github.event.inputs.turboacc_method }}
        path: upload/packages/
        if-no-files-found: warn
