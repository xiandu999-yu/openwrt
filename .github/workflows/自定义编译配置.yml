name: OpenWrt 完整编译（修复版）

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      target_device:
        description: '目标设备'
        required: true
        default: 'nanopi-r3s'
        type: choice
        options:
          - nanopi-r3s
          - nanopi-r6s
      include_sfe:
        description: '包含SFE加速'
        type: boolean
        required: false
        default: true
      compile_threads:
        description: '编译线程数'
        required: false
        default: 'single'  # 改为单线程更稳定
        type: choice
        options:
          - single
          - multi
      build_mode:
        description: '编译模式'
        required: false
        default: 'firmware'  # 改为固件模式节省空间
        type: choice
        options:
          - firmware
          - full
      include_istore:
        description: '包含iStore应用商店'
        type: boolean
        required: false
        default: false  # 默认关闭以节省空间
      turboacc_method:
        description: '加速方案'
        required: false
        default: 'immortalwrt'
        type: choice
        options:
          - immortalwrt
          - hybrid
          - script

env:
  TIMEOUT: 360m

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: 设置构建缓存
      uses: actions/cache@v3
      with:
        path: |
          dl
          /tmp/ccache
        key: ${{ runner.os }}-openwrt-minimal-${{ hashFiles('feeds.conf') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-minimal-

    - name: 设置完整编译环境
      run: bash scripts/setup-environment.sh

    - name: 配置 feeds 源
      run: |
        echo "=== 配置 feeds 源 ==="
        cat > feeds.conf << 'EOF'
        src-git packages https://github.com/openwrt/packages.git
        src-git luci https://github.com/openwrt/luci.git
        EOF

    - name: 更新和安装 feeds
      run: |
        echo "=== 更新 feeds ==="
        ./scripts/feeds update -a
        echo "=== 安装 feeds ==="
        ./scripts/feeds install -a

    - name: 修复 nftables 问题
      run: |
        echo "=== 修复 nftables 编译问题 ==="
        rm -f package/network/utils/nftables/patches/001-fix-pppox-includes.patch 2>/dev/null || true
        find package/network/utils/nftables/patches -name "*.rej" -delete 2>/dev/null || true
        rm -rf build_dir/target-*/nftables-* 2>/dev/null || true

    - name: 应用混合 Fullcone 方案
      run: |
        bash scripts/apply-hybrid-fullcone.sh \
          "${{ github.event.inputs.turboacc_method }}" \
          "${{ github.event.inputs.include_sfe }}"

    - name: 运行 prereq 检查
      run: |
        echo "=== 运行 prereq 检查 ==="
        make prereq

    - name: 应用完整配置（修复版）
      run: |
        bash scripts/apply-config.sh \
          "${{ github.event.inputs.target_device }}" \
          "${{ github.event.inputs.turboacc_method }}" \
          "${{ github.event.inputs.include_sfe }}" \
          "${{ github.event.inputs.include_istore }}" \
          "${{ github.event.inputs.build_mode }}"

    - name: 编译前检查
      run: |
        echo "=== 编译前检查 ==="
        echo "磁盘空间:"
        df -h
        echo "配置文件状态:"
        ls -la .config 2>/dev/null || echo "无配置文件"
        echo "关键配置:"
        grep -E "CONFIG_TARGET|CONFIG_PACKAGE" .config 2>/dev/null | head -10 || echo "无法读取配置"

    - name: 编译固件（修复版）
      run: |
        echo "=== 开始编译 ==="
        
        export FORCE_UNSAFE_CONFIGURE=1
        export CCACHE_DIR="/tmp/ccache"
        
        # 使用单线程确保稳定性
        THREADS=1
        echo "使用单线程编译确保稳定性"
        
        echo "编译开始: $(date)"
        # 编译并实时输出，避免缓冲区问题
        make -j$THREADS V=s 2>&1 | while IFS= read -r line; do
          echo "$line"
        done
        
        echo "编译结束: $(date)"

    - name: 验证编译结果
      if: always()
      run: |
        echo "=== 编译结果验证 ==="
        
        # 检查编译目录是否存在
        if [ ! -d "bin" ]; then
          echo "❌ bin 目录不存在，编译完全失败"
          echo "最后错误信息:"
          tail -50 build.log 2>/dev/null || echo "无编译日志"
          exit 1
        fi
        
        # 检查固件文件
        if find bin -name "*.bin" -o -name "*.img" 2>/dev/null | grep -q .; then
          echo "✅ 编译成功"
          find bin -name "*.bin" -o -name "*.img" | head -5
        else
          echo "❌ 编译失败 - 无固件输出"
          echo "目录结构:"
          find bin -type f 2>/dev/null | head -20 || echo "bin 目录为空"
          exit 1
        fi

    # 后续步骤保持不变...
