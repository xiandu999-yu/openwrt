name: 自定义编译配置

on:
  schedule:
    - cron: '0 4 * * *'  # 每天UTC时间4点编译
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      target:
        description: 'Build target (nanopi-r3s or nanopi-r6s)'
        required: true
        default: 'nanopi-r3s'
        type: choice
        options:
          - nanopi-r3s
          - nanopi-r6s
      include_sfe:
        description: 'Include Shortcut FE acceleration'
        type: boolean
        required: false
        default: false
      turboacc_feature:
        description: 'TurboACC features'
        type: choice
        required: false
        default: 'fullcone-only'
        options:
          - fullcone-only
          - with-sfe

# 设置超时时间
env:
  TIMEOUT: 180m

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3小时超时
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib \
          g++-multilib gettext git libncurses5-dev libssl-dev python3 python3-pip \
          python3-serial unzip zlib1g-dev file wget rsync

    - name: Apply custom modifications
      run: |
        chmod +x scripts/*.sh
        echo "应用基础补丁..."
        ./scripts/apply-custom-patches.sh
        
        echo "集成TurboACC功能..."
        if [ "${{ github.event.inputs.turboacc_feature }}" = "with-sfe" ]; then
          echo "包含SFE加速"
          ./scripts/integrate-features.sh --with-sfe
        else
          echo "仅Fullcone NAT"
          ./scripts/integrate-features.sh
        fi
        
        echo "添加软件包..."
        ./scripts/add-packages.sh

    - name: Update feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Configure build
      run: |
        # 复制基础配置
        if [ "${{ github.event.inputs.target }}" = "nanopi-r3s" ]; then
          cp configs/nanopi-r3s.config .config
          echo "选择NanoPi R3S配置"
        else
          cp configs/nanopi-r6s.config .config
          echo "选择NanoPi R6S配置"
        fi
        
        # 根据参数调整配置
        if [ "${{ github.event.inputs.include_sfe }}" = "true" ] || [ "${{ github.event.inputs.turboacc_feature }}" = "with-sfe" ]; then
          echo "启用Shortcut FE..."
          echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
          echo "CONFIG_PACKAGE_kmod-shortcut-fe-cm=y" >> .config
        fi
        
        # 确保启用TurboACC
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_nft-fullcone=y" >> .config
        
        make defconfig

    - name: Download packages
      run: |
        # 预下载包，避免编译时超时
        make download -j8
        find dl -size +5M -exec ls -lh {} \;

    - name: Build firmware
      run: |
        # 使用更详细的输出，避免无输出导致取消
        echo "开始编译固件..."
        make -j$(($(nproc) + 1)) V=sc 2>&1 | tee build.log || \
        (echo "编译可能失败，检查日志..." && tail -100 build.log && exit 1)

    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-${{ github.event.inputs.target }}-${{ github.event.inputs.turboacc_feature }}
        path: bin/targets/
        retention-days: 30

    - name: Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.event.inputs.target }}
        path: build.log
        retention-days: 7
