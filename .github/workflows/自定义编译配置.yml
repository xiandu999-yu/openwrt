name: 自定义编译配置

on:
  schedule:
    - cron: '0 4 * * *'  # 每天UTC时间4点编译
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      target_device:  # 目标设备
        description: '选择编译目标设备'
        required: true
        default: 'nanopi-r3s'
        type: choice
        options:
          - nanopi-r3s
          - nanopi-r6s
      include_sfe:  # 包含SFE加速
        description: '是否包含Shortcut FE加速'
        type: boolean
        required: false
        default: true
      compile_threads:  # 编译线程数
        description: '选择编译线程数 (单线程更稳定，多线程更快)'
        required: false
        default: 'single'
        type: choice
        options:
          - single
          - multi
      build_mode:  # 编译模式
        description: '选择编译模式 (firmware=全kmods+固件, full=全kmods+固件+全插件)'
        required: false
        default: 'firmware'
        type: choice
        options:
          - firmware
          - full
      include_istore:  # 包含iStore
        description: '是否包含iStore相关功能'
        type: boolean
        required: false
        default: true

env:
  TIMEOUT: 360m

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: 设置构建缓存
      uses: actions/cache@v3
      with:
        path: |
          dl
          build_dir
          staging_dir
          tmp
          .config
          feeds
        key: ${{ runner.os }}-openwrt-${{ hashFiles('configs/*.config', 'feeds.conf', '.config') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-

    - name: 安装系统依赖 (LEDE推荐)
      run: |
        echo "=== 安装LEDE推荐的完整编译依赖 ==="
        sudo apt update -y
        sudo apt full-upgrade -y
        sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext \
        genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
        libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
        libreadline-dev libssl-dev libtool llvm lrzsz libnsl-dev ninja-build p7zip p7zip-full patch pkgconf \
        python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
        swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev

    - name: 检查系统信息
      run: |
        echo "=== 环境信息 ==="
        echo "设备: ${{ github.event.inputs.target_device }}"
        echo "线程: ${{ github.event.inputs.compile_threads }}"
        echo "模式: ${{ github.event.inputs.build_mode }}"
        echo "iStore: ${{ github.event.inputs.include_istore }}"
        echo "SFE: ${{ github.event.inputs.include_sfe }}"
        echo "CPU: $(nproc) 核心"
        echo "内存: $(free -h | grep Mem | awk '{print $2}')"
        echo "系统: $(lsb_release -d | cut -f2)"
        echo ""

    - name: 配置 feeds 源
      run: |
        echo "配置 feeds 源..."
        cat > feeds.conf << 'EOF'
        src-git packages https://github.com/openwrt/packages.git
        src-git luci https://github.com/openwrt/luci.git
        src-git routing https://github.com/openwrt/routing.git
        src-git telephony https://github.com/openwrt/telephony.git
        EOF

    - name: 更新和安装 feeds
      run: |
        echo "更新 feeds..."
        ./scripts/feeds update -a
        echo "安装 feeds..."
        ./scripts/feeds install -a

    - name: 运行 prereq 检查
      run: |
        echo "=== 运行 prereq 依赖检查 ==="
        make prereq
        echo "✅ prereq 检查通过"

    - name: 应用基础配置
      run: |
        echo "=== 应用基础设备配置 ==="
        if [ "${{ github.event.inputs.target_device }}" = "nanopi-r3s" ]; then
          cp configs/nanopi-r3s.config .config
          echo "选择 NanoPi R3S 配置"
        else
          cp configs/nanopi-r6s.config .config
          echo "选择 NanoPi R6S 配置"
        fi
        
        # 应用基础配置
        make defconfig
        echo "✅ 基础配置完成"

    - name: 检查自定义包是否存在
      run: |
        echo "=== 检查自定义包是否存在 ==="
        
        echo "1. 检查 TurboACC 相关包:"
        find . -name "*turboacc*" -type d 2>/dev/null | head -10 || echo "  未找到 TurboACC 包"
        find feeds -name "*turboacc*" -type d 2>/dev/null | head -10 || echo "  feeds中未找到 TurboACC"
        ./scripts/feeds list | grep -i turboacc || echo "  feeds列表中无 turboacc"
        
        echo ""
        echo "2. 检查 Shortcut FE 相关包:"
        find . -name "*shortcut*" -type d 2>/dev/null | head -10 || echo "  未找到 Shortcut FE 包"
        find . -name "*fast-classifier*" -type d 2>/dev/null | head -10 || echo "  未找到 Fast Classifier 包"
        find feeds -name "*shortcut*" -type d 2>/dev/null | head -10 || echo "  feeds中未找到 Shortcut FE"
        ./scripts/feeds list | grep -i shortcut || echo "  feeds列表中无 shortcut"
        
        echo ""
        echo "3. 检查 iStore 相关包:"
        find . -name "*istore*" -type d 2>/dev/null | head -10 || echo "  未找到 iStore 包"
        find feeds -name "*store*" -type d | grep -v ".git" | head -10 || echo "  feeds中store相关包有限"
        ./scripts/feeds list | grep -i store | head -10 || echo "  feeds列表中store包有限"

    - name: 添加自定义包功能
      run: |
        echo "=== 添加自定义包功能 ==="
        
        # 确保脚本有执行权限
        chmod +x scripts/*.sh 2>/dev/null || echo "无脚本文件"
        
        # 添加 iStore 相关包
        if [ "${{ github.event.inputs.include_istore }}" = "true" ]; then
          echo "添加 iStore 相关包..."
          if [ -f "scripts/add-packages.sh" ]; then
            ./scripts/add-packages.sh
            echo "✅ iStore 包添加完成"
          else
            echo "⚠️ scripts/add-packages.sh 不存在，跳过 iStore"
          fi
        fi
        
        # 添加网络加速功能
        echo "添加网络加速功能..."
        if [ -f "scripts/integrate-features.sh" ]; then
          if [ "${{ github.event.inputs.include_sfe }}" = "true" ]; then
            ./scripts/integrate-features.sh --with-sfe
          else
            ./scripts/integrate-features.sh
          fi
          echo "✅ 网络加速功能添加完成"
        else
          echo "⚠️ scripts/integrate-features.sh 不存在，跳过网络加速"
        fi

    - name: 重新安装 feeds（包含新包）
      run: |
        echo "=== 重新安装 feeds（包含新包）==="
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "✅ feeds 重新安装完成"

    - name: 配置核心功能
      run: |
        echo "=== 配置核心功能 ==="
        
        # 启用全内核模块
        echo "CONFIG_ALL_KMODS=y" >> .config
        
        # 基础系统配置
        echo "CONFIG_USE_APK=y" >> .config
        
        # 禁用有问题的包
        echo "# CONFIG_PACKAGE_rtpengine is not set" >> .config
        echo "# CONFIG_PACKAGE_freeswitch is not set" >> .config
        echo "# CONFIG_PACKAGE_asterisk is not set" >> .config
        
        # TurboACC配置 - 检查包存在性
        if find . -name "*turboacc*" -type d | grep -q . || find feeds -name "*turboacc*" -type d | grep -q .; then
          echo "配置 TurboACC..."
          echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
          echo "CONFIG_PACKAGE_nft-fullcone=y" >> .config
          echo "CONFIG_PACKAGE_kmod-nft-fullcone=y" >> .config
          echo "CONFIG_PACKAGE_kmod-ipt-fullconenat=y" >> .config
        else
          echo "⚠️ TurboACC 包不存在，跳过配置"
        fi
        
        # Shortcut FE配置 - 详细检查
        if [ "${{ github.event.inputs.include_sfe }}" = "true" ]; then
          echo "检查 Shortcut FE 包状态..."
          SFE_FOUND=false
          
          # 检查各种可能的包名
          for pkg in shortcut-fe fast-classifier; do
            if find . -name "*$pkg*" -type d | grep -q . || find feeds -name "*$pkg*" -type d | grep -q .; then
              SFE_FOUND=true
              echo "找到 $pkg 包"
            fi
          done
          
          if [ "$SFE_FOUND" = "true" ]; then
            echo "配置 Shortcut FE..."
            echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
            echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
            echo "CONFIG_PACKAGE_kmod-shortcut-fe-drv=y" >> .config
            echo "CONFIG_PACKAGE_kmod-shortcut-fe-cm=y" >> .config
          else
            echo "⚠️ Shortcut FE 包不存在，跳过配置"
          fi
        fi
        
        # 根据编译模式配置
        if [ "${{ github.event.inputs.build_mode }}" = "full" ]; then
          echo "CONFIG_PACKAGE_bash=y" >> .config
          echo "CONFIG_PACKAGE_htop=y" >> .config
          echo "CONFIG_PACKAGE_nano=y" >> .config
          echo "CONFIG_PACKAGE_vim=y" >> .config
          echo "CONFIG_PACKAGE_curl=y" >> .config
        fi
        
        # iStore配置 - 检查包存在性
        if [ "${{ github.event.inputs.include_istore }}" = "true" ]; then
          if [ -d "package/luci-app-istorex" ] || find . -name "*istore*" -type d | grep -q .; then
            echo "配置 iStore..."
            echo "CONFIG_PACKAGE_luci-app-istorex=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-store=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-quickstart=y" >> .config
            echo "CONFIG_PACKAGE_luci-lib-taskd=y" >> .config
            echo "CONFIG_PACKAGE_quickstart=y" >> .config
            echo "CONFIG_PACKAGE_luci-lib-xterm=y" >> .config
            echo "CONFIG_PACKAGE_taskd=y" >> .config
          else
            echo "⚠️ iStore 包不存在，跳过配置"
          fi
        fi
        
        # 重新应用配置
        make defconfig
        echo "✅ 核心功能配置完成"

    - name: 启用必需的内核模块
      run: |
        echo "=== 启用必需的内核模块 ==="
        
        # 网络核心模块
        echo "CONFIG_PACKAGE_kmod-ppp=y" >> .config
        echo "CONFIG_PACKAGE_kmod-pppoe=y" >> .config
        echo "CONFIG_PACKAGE_kmod-nf-nat=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipv6=y" >> .config
        
        # 文件系统
        echo "CONFIG_PACKAGE_kmod-fs-ext4=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-squashfs=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-vfat=y" >> .config
        
        # USB支持
        echo "CONFIG_PACKAGE_kmod-usb-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-storage=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
        
        # 加密
        echo "CONFIG_PACKAGE_kmod-crypto-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-crypto-hash=y" >> .config
        
        # 其他核心模块
        echo "CONFIG_PACKAGE_kmod-nls-base=y" >> .config
        echo "CONFIG_PACKAGE_kmod-nls-utf8=y" >> .config
        
        # 应用配置
        make oldconfig
        echo "✅ 内核模块配置完成"

    - name: 最终配置验证
      run: |
        echo "=== 最终配置验证 ==="
        
        echo "核心功能状态:"
        echo "✅ 全内核模块"
        echo "✅ PPP支持" 
        echo "✅ Netfilter NAT"
        echo "✅ EXT4文件系统"
        echo "✅ USB核心"
        
        # 安全检查，不触发错误
        if grep -q "^CONFIG_PACKAGE_luci-app-turboacc=y" .config 2>/dev/null || grep -q "^CONFIG_PACKAGE_luci-app-turboacc=m" .config 2>/dev/null; then
          echo "✅ TurboACC"
        else
          echo "⚠️ TurboACC - 未启用"
        fi
        
        if [ "${{ github.event.inputs.include_sfe }}" = "true" ]; then
          if grep -q "^CONFIG_PACKAGE_kmod-shortcut-fe=y" .config 2>/dev/null || grep -q "^CONFIG_PACKAGE_kmod-shortcut-fe=m" .config 2>/dev/null; then
            echo "✅ Shortcut FE"
          else
            echo "⚠️ Shortcut FE - 未启用"
          fi
        fi
        
        if [ "${{ github.event.inputs.include_istore }}" = "true" ]; then
          if grep -q "^CONFIG_PACKAGE_luci-app-istorex=y" .config 2>/dev/null || grep -q "^CONFIG_PACKAGE_luci-app-istorex=m" .config 2>/dev/null; then
            echo "✅ iStore"
          else
            echo "⚠️ iStore - 未启用"
          fi
        fi
        
        echo ""
        echo "配置统计:"
        echo "总配置项: $(grep -c "^CONFIG_" .config 2>/dev/null || echo 0)"
        echo "编译进内核: $(grep "^CONFIG_.*=y" .config 2>/dev/null | wc -l)"
        echo "编译为模块: $(grep "^CONFIG_.*=m" .config 2>/dev/null | wc -l)"
        
        echo "✅ 配置验证完成，开始编译"

    - name: 修复常见问题
      run: |
        echo "=== 修复常见编译问题 ==="
        
        # 清理有问题的包
        rm -rf feeds/telephony/net/rtpengine 2>/dev/null || true
        
        # 修复Shortcut FE配置
        if [ -d "package/qca/shortcut-fe" ]; then
          echo "修复 Shortcut FE 配置..."
          find package/qca/shortcut-fe -name "*.mk" -exec sed -i 's/kmod-shortcut-fe-cm/kmod-shortcut-fe/g' {} \; 2>/dev/null || true
        fi

    - name: 生成版本信息
      run: |
        echo "=== 生成版本信息 ==="
        {
          echo "固件版本: OpenWrt SNAPSHOT"
          echo "内核版本: 6.12"
          echo "编译时间: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "目标设备: ${{ github.event.inputs.target_device }}"
          echo "编译模式: ${{ github.event.inputs.build_mode }}"
          echo "包含功能:"
          echo "  - 全内核模块"
          echo "  - Fullcone NAT"
          
          if [ "${{ github.event.inputs.include_sfe }}" = "true" ]; then
            echo "  - Shortcut FE加速"
          else
            echo "  - 无SFE加速"
          fi
          
          if [ "${{ github.event.inputs.include_istore }}" = "true" ]; then
            echo "  - iStore应用商店"
          else
            echo "  - 无iStore"
          fi
          
          echo "Git提交: $(git log -1 --format=%h)"
        } > version-info.txt
        
        cat version-info.txt

    - name: 编译固件
      run: |
        echo "=== 开始编译 ==="
        
        # 设置线程数
        if [ "${{ github.event.inputs.compile_threads }}" = "multi" ]; then
          THREADS=$(nproc)
          echo "使用多线程模式: $THREADS 个CPU核心"
        else
          THREADS=1
          echo "使用单线程模式: 1 个CPU核心 (系统有 $(nproc) 个核心)"
        fi
        
        # 设置环境变量
        export FORCE_UNSAFE_CONFIGURE=1
        
        echo "开始完整编译..."
        set +e  # 禁用错误退出
        if [ "$THREADS" -eq 1 ]; then
          make -j1 V=s 2>&1 | tee build.log
          COMPILE_RESULT=${PIPESTATUS[0]}
        else
          make -j$THREADS V=s 2>&1 | tee build.log
          COMPILE_RESULT=${PIPESTATUS[0]}
        fi
        set -e  # 重新启用错误退出
        
        # 检查编译结果
        if [ -d "bin/targets" ] && [ $(find bin/targets/ -name "*.bin" -o -name "*.img" 2>/dev/null | wc -l) -gt 0 ]; then
          echo "✅ 固件文件已生成，编译成功"
          exit 0
        elif [ -d "bin/packages" ] && [ $(find bin/packages/ -name "*.ipk" 2>/dev/null | wc -l) -gt 0 ]; then
          echo "⚠️ 只有软件包生成，编译部分成功"
          exit 0
        elif [ $COMPILE_RESULT -eq 0 ]; then
          echo "✅ 编译过程完成（无错误）"
          exit 0
        else
          echo "❌ 编译失败"
          exit $COMPILE_RESULT
        fi

    - name: 收集构建产物
      if: always()
      run: |
        echo "=== 收集构建产物 ==="
        mkdir -p upload/firmware upload/packages upload/logs
        
        # 收集固件
        find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \) -exec cp --parents {} upload/firmware/ \; 2>/dev/null || true
        
        # 收集软件包
        if [ -d "bin/packages" ]; then
          cp -r bin/packages/* upload/packages/ 2>/dev/null || true
        fi
        
        # 收集日志和配置
        cp version-info.txt upload/ 2>/dev/null || true
        cp .config upload/ 2>/dev/null || true
        cp build.log upload/logs/ 2>/dev/null || true
        
        echo "产物统计:"
        echo "固件文件: $(find upload/firmware -type f 2>/dev/null | wc -l || echo 0) 个"
        echo "软件包: $(find upload/packages -name "*.ipk" 2>/dev/null | wc -l || echo 0) 个"
        find upload/firmware -type f 2>/dev/null | head -10 || echo "无固件文件"

    - name: 上传固件
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.target_device }}-${{ github.event.inputs.build_mode }}
        path: upload/firmware/
        retention-days: 30
        if-no-files-found: warn

    - name: 上传软件包
      uses: actions/upload-artifact@v4
      with:
        name: packages-${{ github.event.inputs.target_device }}-${{ github.event.inputs.build_mode }}
        path: upload/packages/
        retention-days: 30
        if-no-files-found: warn

    - name: 上传构建信息
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-info-${{ github.event.inputs.target_device }}-${{ github.event.inputs.build_mode }}
        path: upload/
        retention-days: 7
        if-no-files-found: warn
