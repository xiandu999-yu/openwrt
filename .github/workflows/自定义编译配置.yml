name: 自定义编译配置

on:
  schedule:
    - cron: '0 4 * * *'  # 每天UTC时间4点编译
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      target_device:  # 目标设备
        description: '选择编译目标设备'
        required: true
        default: 'nanopi-r3s'
        type: choice
        options:
          - nanopi-r3s
          - nanopi-r6s
      include_sfe:  # 包含SFE加速
        description: '是否包含Shortcut FE加速'
        type: boolean
        required: false
        default: false
      turboacc_feature:  # TurboACC功能
        description: '选择TurboACC功能配置'
        type: choice
        required: false
        default: 'fullcone-only'
        options:
          - fullcone-only
          - with-sfe

env:
  TIMEOUT: 180m

jobs:
  build:  # 编译
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3小时超时
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: 设置构建缓存
      uses: actions/cache@v3
      with:
        path: |
          dl
          build_dir
          staging_dir
          tmp
        key: ${{ runner.os }}-openwrt-${{ hashFiles('configs/*.config', 'feeds.conf', '.config') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-

    - name: 安装系统依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          g++-multilib \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-pip \
          python3-setuptools \
          python3-dev \
          python3-serial \
          unzip \
          zlib1g-dev \
          file \
          wget \
          rsync \
          libelf-dev

    - name: 安装Python依赖
      run: |
        python3 -m pip install --upgrade pip
        python3 -m pip install pyelftools cffi

    - name: 应用自定义修改
      run: |
        chmod +x scripts/*.sh
        echo "应用基础补丁..."
        ./scripts/apply-custom-patches.sh
        
        echo "修复依赖关系..."
        ./scripts/fix-dependencies.sh
        
        echo "修复 libnftnl 编译问题..."
        ./scripts/fix-libnftnl.sh
        
        echo "集成TurboACC功能..."
        if [ "${{ github.event.inputs.turboacc_feature }}" = "with-sfe" ]; then
          echo "包含SFE加速"
          ./scripts/integrate-features.sh --with-sfe
          echo "添加 Shortcut FE 支持..."
          ./scripts/add-shortcut-fe.sh
        else
          echo "仅Fullcone NAT"
          ./scripts/integrate-features.sh
        fi
        
        echo "添加软件包..."
        ./scripts/add-packages.sh

    - name: 检查编译环境
      run: |
        echo "检查关键包状态..."
        # 检查 libnftnl
        if [ -d "package/libs/libnftnl" ]; then
            echo "✅ libnftnl 存在"
            ls package/libs/libnftnl/patches/ 2>/dev/null || echo "无补丁"
        else
            echo "❌ libnftnl 不存在"
        fi
        
        # 检查 shortcut-fe
        if [ -f "package/network/shortcut-fe/Makefile" ]; then
            echo "✅ shortcut-fe 存在"
        else
            echo "⚠️ shortcut-fe 不存在"
        fi

    - name: 更新软件源
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 配置编译参数
      run: |
        if [ "${{ github.event.inputs.target_device }}" = "nanopi-r3s" ]; then
          cp configs/nanopi-r3s.config .config
          echo "选择NanoPi R3S配置"
        else
          cp configs/nanopi-r6s.config .config
          echo "选择NanoPi R6S配置"
        fi
        
        # 内核模块配置
        echo "CONFIG_ALL_KMODS=y" >> .config
        echo "CONFIG_ALL_NONSHARED=n" >> .config
        
        # 启用APK包管理
        echo "CONFIG_USE_APK=y" >> .config
        
        # 基础系统
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-base=y" >> .config
        echo "CONFIG_PACKAGE_luci-compat=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
        echo "CONFIG_LUCI_LANG_zh-cn=y" >> .config
        
        # TurboACC核心功能
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_nft-fullcone=y" >> .config
        
        # 根据参数调整配置
        if [ "${{ github.event.inputs.include_sfe }}" = "true" ] || [ "${{ github.event.inputs.turboacc_feature }}" = "with-sfe" ]; then
          echo "启用完整的 Shortcut FE..."
          echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
          echo "CONFIG_PACKAGE_kmod-shortcut-fe-cm=y" >> .config
          echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
        fi
        
        # 系统工具
        echo "CONFIG_PACKAGE_curl=y" >> .config
        echo "CONFIG_PACKAGE_bash=y" >> .config
        echo "CONFIG_PACKAGE_htop=y" >> .config
        echo "CONFIG_PACKAGE_nano=y" >> .config
        
        make defconfig

    - name: 生成版本信息
      run: |
        echo "=== 固件版本信息 ===" > version-info.txt
        echo "基础版本: OpenWrt SNAPSHOT (开发版)" >> version-info.txt
        echo "内核版本: 6.12" >> version-info.txt
        echo "包管理器: apk" >> version-info.txt
        echo "编译时间: $(date '+%Y-%m-%d %H:%M:%S')" >> version-info.txt
        echo "目标设备: ${{ github.event.inputs.target_device }}" >> version-info.txt
        echo "TurboACC功能: ${{ github.event.inputs.turboacc_feature }}" >> version-info.txt
        echo "包含SFE: ${{ github.event.inputs.include_sfe }}" >> version-info.txt
        echo "Git提交: $(git log -1 --format=%h)" >> version-info.txt
        echo "自定义功能: Fullcone NAT + TurboACC" >> version-info.txt
        cat version-info.txt

    - name: 下载软件包
      run: |
        echo "开始下载软件包..."
        make download -j4
        echo "下载完成"

    - name: 编译工具链
      run: |
        echo "编译工具链..."
        make toolchain/compile -j$(nproc)
        make toolchain/install -j$(nproc)

    - name: 编译内核和模块
      run: |
        echo "编译内核和所有模块..."
        # 编译所有内核模块，但作为独立包
        make target/linux/compile -j$(nproc)

    - name: 编译软件包
      run: |
        echo "编译软件包..."
        make package/compile -j$(nproc)

    - name: 生成固件镜像
      run: |
        echo "生成固件镜像..."
        make -j1 V=s
        
        echo "编译产物列表:"
        find bin/targets -name "*.img" -o -name "*.bin" -o -name "*.gz" | head -10

    - name: 生成软件包索引
      run: |
        echo "生成APK软件包索引..."
        make package/index

    - name: 上传固件镜像
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.target_device }}-${{ github.event.inputs.turboacc_feature }}
        path: |
          bin/targets/
          version-info.txt
        retention-days: 30

    - name: 上传软件包
      uses: actions/upload-artifact@v4
      with:
        name: packages-${{ github.event.inputs.target_device }}
        path: |
          bin/packages/
        retention-days: 30

    - name: 上传构建日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.event.inputs.target_device }}
        path: |
          build.log
          .config
        retention-days: 7
