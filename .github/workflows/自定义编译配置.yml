name: OpenWrt 编译（修复 prereq 问题）

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      target_device:
        description: '目标设备'
        required: true
        default: 'nanopi-r3s'
        type: choice
        options:
          - nanopi-r3s
          - nanopi-r6s
      turboacc_method:
        description: '加速方案'
        required: false
        default: 'immortalwrt'
        type: choice
        options:
          - immortalwrt
          - hybrid
          - script

env:
  TIMEOUT: 360m

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: 设置构建缓存
      uses: actions/cache@v3
      with:
        path: |
          dl
          /tmp/ccache
        key: ${{ runner.os }}-openwrt-${{ hashFiles('feeds.conf') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-

    - name: 安装编译环境
      run: |
        echo "=== 安装编译环境 ==="
        sudo apt update -y
        sudo apt install -y \
          build-essential \
          ccache \
          curl \
          file \
          g++ \
          gawk \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          make \
          python3 \
          rsync \
          unzip
        sudo apt clean

    - name: 配置 feeds
      run: |
        echo "=== 配置 feeds ==="
        cat > feeds.conf << 'EOF'
        src-git packages https://github.com/openwrt/packages.git
        src-git luci https://github.com/openwrt/luci.git
        EOF
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 修复 nftables 问题
      run: |
        echo "=== 修复 nftables ==="
        rm -f package/network/utils/nftables/patches/001-fix-pppox-includes.patch 2>/dev/null || true

    - name: 运行非交互式依赖检查
      run: bash scripts/check-prereq.sh

    - name: 创建设备配置
      run: |
        echo "=== 创建设备配置 ==="
        bash scripts/create-base-config.sh "${{ github.event.inputs.target_device }}"

    - name: 应用功能配置
      run: |
        echo "=== 应用功能配置 ==="
        
        export FORCE_UNSAFE_CONFIGURE=1
        
        # 应用 TurboACC 配置
        case "${{ github.event.inputs.turboacc_method }}" in
          "script")
            echo "应用脚本方案..."
            curl -sSL https://raw.githubusercontent.com/chenmozhijin/turboacc/luci/add_turboacc.sh -o add_turboacc.sh
            chmod +x add_turboacc.sh
            bash add_turboacc.sh --no-sfe  # 先不加 SFE 确保基础编译
            ;;
          *)
            echo "应用标准方案..."
            echo "CONFIG_PACKAGE_firewall4=y" >> .config
            echo "CONFIG_PACKAGE_nftables-json=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
            ;;
        esac
        
        # 非交互式配置验证
        echo "运行 defconfig..."
        make defconfig

    - name: 编译固件
      run: |
        echo "=== 开始编译 ==="
        
        export FORCE_UNSAFE_CONFIGURE=1
        export CCACHE_DIR="/tmp/ccache"
        
        # 单线程编译确保成功
        echo "使用单线程编译..."
        make -j1 V=s 2>&1 | tail -100

    - name: 检查编译结果
      run: |
        echo "=== 编译结果 ==="
        if find bin -name "*.bin" -o -name "*.img" 2>/dev/null | grep -q .; then
          echo "✅ 编译成功!"
          find bin -name "*.bin" -o -name "*.img" | head -5
        else
          echo "❌ 编译失败"
          exit 1
        fi

    - name: 上传产物
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-${{ github.event.inputs.target_device }}
        path: bin/
        retention-days: 3
        if-no-files-found: error
