name: 自定义编译配置

on:
  schedule:
    - cron: '0 4 * * *'  # 每天UTC时间4点编译
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      target:
        description: 'Build target (nanopi-r3s or nanopi-r6s)'
        required: true
        default: 'nanopi-r3s'
        type: choice
        options:
          - nanopi-r3s
          - nanopi-r6s
      include_sfe:
        description: 'Include Shortcut FE acceleration'
        type: boolean
        required: false
        default: false
      turboacc_feature:
        description: 'TurboACC features'
        type: choice
        required: false
        default: 'fullcone-only'
        options:
          - fullcone-only
          - with-sfe

env:
  TIMEOUT: 180m

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3小时超时
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup build cache
      uses: actions/cache@v3
      with:
        path: |
          dl
          build_dir
          staging_dir
          tmp
        key: ${{ runner.os }}-openwrt-${{ hashFiles('configs/*.config', 'feeds.conf', '.config') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-

    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib \
          g++-multilib gettext git libncurses5-dev libssl-dev python3 python3-pip \
          python3-serial unzip zlib1g-dev file wget rsync libelf-dev

    - name: Install Python dependencies
      run: |
        python3 -m pip install --upgrade pip
        python3 -m pip install pyelftools cffi

    - name: Apply custom modifications
      run: |
        chmod +x scripts/*.sh
        echo "应用基础补丁..."
        ./scripts/apply-custom-patches.sh
        
        echo "集成TurboACC功能..."
        if [ "${{ github.event.inputs.turboacc_feature }}" = "with-sfe" ]; then
          echo "包含SFE加速"
          ./scripts/integrate-features.sh --with-sfe
        else
          echo "仅Fullcone NAT"
          ./scripts/integrate-features.sh
        fi
        
        echo "添加软件包..."
        ./scripts/add-packages.sh

    - name: Update feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Configure build for modular kmod
      run: |
        # 复制基础配置
        if [ "${{ github.event.inputs.target }}" = "nanopi-r3s" ]; then
          cp configs/nanopi-r3s.config .config
          echo "选择NanoPi R3S配置"
        else
          cp configs/nanopi-r6s.config .config
          echo "选择NanoPi R6S配置"
        fi
        
        # 启用模块化编译
        echo "CONFIG_MODULES=y" >> .config
        echo "CONFIG_ALL_KMODS=n" >> .config  # 不编译所有kmod
        echo "CONFIG_ALL_NONSHARED=n" >> .config
        
        # 启用Luci界面
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-base=y" >> .config
        echo "CONFIG_PACKAGE_luci-compat=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
        echo "CONFIG_LUCI_LANG_zh-cn=y" >> .config
        
        # 基础网络服务
        echo "CONFIG_PACKAGE_dnsmasq-full=y" >> .config
        echo "CONFIG_PACKAGE_firewall4=y" >> .config
        echo "CONFIG_PACKAGE_iptables-nft=y" >> .config
        echo "CONFIG_PACKAGE_ppp=y" >> .config
        echo "CONFIG_PACKAGE_ppp-mod-pppoe=y" >> .config
        
        # 根据参数调整配置
        if [ "${{ github.event.inputs.include_sfe }}" = "true" ] || [ "${{ github.event.inputs.turboacc_feature }}" = "with-sfe" ]; then
          echo "启用Shortcut FE..."
          echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
          echo "CONFIG_PACKAGE_kmod-shortcut-fe-cm=y" >> .config
        fi
        
        # 确保启用TurboACC
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_nft-fullcone=y" >> .config
        
        # 启用常用工具
        echo "CONFIG_PACKAGE_curl=y" >> .config
        echo "CONFIG_PACKAGE_bash=y" >> .config
        echo "CONFIG_PACKAGE_htop=y" >> .config
        echo "CONFIG_PACKAGE_nano=y" >> .config
        
        make defconfig

    - name: Download packages with cache
      run: |
        echo "开始下载包..."
        make download -j4
        echo "下载完成，缓存大小:"
        du -sh dl || echo "dl目录不存在"

    - name: Build toolchain with cache
      run: |
        echo "编译工具链..."
        make toolchain/compile -j$(nproc)
        make toolchain/install -j$(nproc)

    - name: Build kernel modules separately
      run: |
        echo "编译内核模块..."
        # 单独编译内核模块，不打包进固件
        make target/linux/compile -j$(nproc) V=s
        echo "内核模块编译完成"

    - name: Build packages separately
      run: |
        echo "编译软件包..."
        # 分别编译不同类别的包
        make package/compile -j$(nproc) V=s
        echo "软件包编译完成"

    - name: Build firmware image
      run: |
        echo "生成固件镜像..."
        # 只生成镜像，不重新编译
        make -j1 V=s 2>&1 | grep -E "(Image|Creating|Generating|Building kernel)" || true
        
        # 检查固件生成
        echo "固件生成状态:"
        find bin/targets -name "*.img" -o -name "*.bin" -o -name "*.gz" 2>/dev/null | head -10

    - name: Build IPK packages
      run: |
        echo "生成IPK软件包..."
        make package/index V=s
        echo "IPK包生成完成"

    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.target }}-${{ github.event.inputs.turboacc_feature }}
        path: |
          bin/targets/
        retention-days: 30

    - name: Upload IPK packages
      uses: actions/upload-artifact@v4
      with:
        name: ipk-packages-${{ github.event.inputs.target }}
        path: |
          bin/packages/
        retention-days: 30

    - name: Upload build info
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-info-${{ github.event.inputs.target }}
        path: |
          .config
          build.log
        retention-days: 7
