name: è‡ªå®šä¹‰ç¼–è¯‘é…ç½®

on:
  schedule:
    - cron: '0 4 * * *'  # æ¯å¤©UTCæ—¶é—´4ç‚¹ç¼–è¯‘
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      target_device:  # ç›®æ ‡è®¾å¤‡
        description: 'é€‰æ‹©ç¼–è¯‘ç›®æ ‡è®¾å¤‡'
        required: true
        default: 'nanopi-r3s'
        type: choice
        options:
          - nanopi-r3s
          - nanopi-r6s
      include_sfe:  # åŒ…å«SFEåŠ é€Ÿ
        description: 'æ˜¯å¦åŒ…å«Shortcut FEåŠ é€Ÿ'
        type: boolean
        required: false
        default: true
      compile_threads:  # ç¼–è¯‘çº¿ç¨‹æ•°
        description: 'é€‰æ‹©ç¼–è¯‘çº¿ç¨‹æ•° (å•çº¿ç¨‹æ›´ç¨³å®šï¼Œå¤šçº¿ç¨‹æ›´å¿«)'
        required: false
        default: 'single'
        type: choice
        options:
          - single
          - multi
      build_mode:  # ç¼–è¯‘æ¨¡å¼
        description: 'é€‰æ‹©ç¼–è¯‘æ¨¡å¼ (firmware=å…¨kmods+å›ºä»¶, full=å…¨kmods+å›ºä»¶+å…¨æ’ä»¶)'
        required: false
        default: 'firmware'
        type: choice
        options:
          - firmware
          - full
      include_istore:  # åŒ…å«iStore
        description: 'æ˜¯å¦åŒ…å«iStoreç›¸å…³åŠŸèƒ½'
        type: boolean
        required: false
        default: true

env:
  TIMEOUT: 360m

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: è®¾ç½®æ„å»ºç¼“å­˜
      uses: actions/cache@v3
      with:
        path: |
          dl
          build_dir
          staging_dir
          tmp
          .config
          feeds
        key: ${{ runner.os }}-openwrt-${{ hashFiles('configs/*.config', 'feeds.conf', '.config') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-

    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (LEDEæ¨è)
      run: |
        echo "=== å®‰è£…LEDEæ¨èçš„å®Œæ•´ç¼–è¯‘ä¾èµ– ==="
        sudo apt update -y
        sudo apt full-upgrade -y
        sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext \
        genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
        libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
        libreadline-dev libssl-dev libtool llvm lrzsz libnsl-dev ninja-build p7zip p7zip-full patch pkgconf \
        python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
        swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev

    - name: æ£€æŸ¥ç³»ç»Ÿä¿¡æ¯
      run: |
        echo "=== ç¯å¢ƒä¿¡æ¯ ==="
        echo "è®¾å¤‡: ${{ github.event.inputs.target_device }}"
        echo "çº¿ç¨‹: ${{ github.event.inputs.compile_threads }}"
        echo "æ¨¡å¼: ${{ github.event.inputs.build_mode }}"
        echo "iStore: ${{ github.event.inputs.include_istore }}"
        echo "SFE: ${{ github.event.inputs.include_sfe }}"
        echo "CPU: $(nproc) æ ¸å¿ƒ"
        echo "å†…å­˜: $(free -h | grep Mem | awk '{print $2}')"
        echo "ç³»ç»Ÿ: $(lsb_release -d | cut -f2)"
        echo ""

    - name: é…ç½® feeds æº
      run: |
        echo "é…ç½® feeds æº..."
        cat > feeds.conf << 'EOF'
        src-git packages https://github.com/openwrt/packages.git
        src-git luci https://github.com/openwrt/luci.git
        src-git routing https://github.com/openwrt/routing.git
        src-git telephony https://github.com/openwrt/telephony.git
        EOF

    - name: æ›´æ–°å’Œå®‰è£… feeds
      run: |
        echo "æ›´æ–° feeds..."
        ./scripts/feeds update -a
        echo "å®‰è£… feeds..."
        ./scripts/feeds install -a

    - name: ä¸‹è½½å¹¶åº”ç”¨å®Œæ•´çš„ LEDE Fullcone NAT æ–¹æ¡ˆ
      run: |
        echo "=== ä¸‹è½½å¹¶åº”ç”¨å®Œæ•´çš„ LEDE Fullcone NAT æ–¹æ¡ˆ ==="
        
        # åˆ›å»ºè¡¥ä¸ç›®å½•ç»“æ„
        mkdir -p target/linux/generic/hack-6.12
        mkdir -p package/libs/libnftnl/patches
        mkdir -p package/network/utils/nftables/patches
        mkdir -p package/network/config/firewall4/patches
        mkdir -p package/network/config/firewall/patches
        mkdir -p package/network/utils/iptables/patches
        mkdir -p package/network/services/fullconenat-nft
        mkdir -p package/network/services/fullconenat/src
        
        # è®¾ç½®é‡è¯•æœºåˆ¶å’Œé”™è¯¯å¤„ç†
        download_with_retry() {
          local url=$1
          local output=$2
          local retries=3
          local timeout=30
          
          for i in $(seq 1 $retries); do
            echo "ä¸‹è½½å°è¯• $i: $output"
            if curl -f --connect-timeout $timeout -sSL "$url" -o "$output"; then
              echo "âœ… ä¸‹è½½æˆåŠŸ: $(basename $output)"
              return 0
            else
              echo "âŒ ä¸‹è½½å¤±è´¥ $i: $(basename $output)"
              sleep 2
            fi
          done
          echo "âš ï¸ è·³è¿‡: $(basename $output)"
          return 1
        }
        
        # 1. ä¸‹è½½ BCM Fullcone NAT å†…æ ¸è¡¥ä¸
        echo "ä¸‹è½½ BCM Fullcone NAT å†…æ ¸è¡¥ä¸..."
        download_with_retry \
          "https://raw.githubusercontent.com/coolsnowwolf/lede/master/target/linux/generic/hack-6.6/982-add-bcm-fullconenat-support.patch" \
          "target/linux/generic/hack-6.12/982-add-bcm-fullconenat-support.patch"
        
        # 2. ä¸‹è½½ libnftnl Fullcone è¡¨è¾¾å¼æ”¯æŒ
        echo "ä¸‹è½½ libnftnl Fullcone è¡¨è¾¾å¼æ”¯æŒ..."
        download_with_retry \
          "https://raw.githubusercontent.com/coolsnowwolf/lede/master/package/libs/libnftnl/patches/001-libnftnl-add-fullcone-expression-support.patch" \
          "package/libs/libnftnl/patches/001-libnftnl-add-fullcone-expression-support.patch"
        
        # 3. ä¸‹è½½ nftables Fullcone è¡¨è¾¾å¼æ”¯æŒ
        echo "ä¸‹è½½ nftables Fullcone è¡¨è¾¾å¼æ”¯æŒ..."
        download_with_retry \
          "https://raw.githubusercontent.com/coolsnowwolf/lede/master/package/network/utils/nftables/patches/002-nftables-add-fullcone-expression-support.patch" \
          "package/network/utils/nftables/patches/002-nftables-add-fullcone-expression-support.patch"
        
        # 4. ä¸‹è½½ firewall4 Fullcone æ”¯æŒ
        echo "ä¸‹è½½ firewall4 Fullcone æ”¯æŒ..."
        download_with_retry \
          "https://raw.githubusercontent.com/coolsnowwolf/lede/master/package/network/config/firewall4/patches/001-firewall4-add-support-for-fullcone-nat.patch" \
          "package/network/config/firewall4/patches/001-firewall4-add-support-for-fullcone-nat.patch"
        
        # 5. ä¸‹è½½ä¼ ç»Ÿ iptables Fullcone NAT æ”¯æŒ
        echo "ä¸‹è½½ä¼ ç»Ÿ iptables Fullcone NAT æ”¯æŒ..."
        download_with_retry \
          "https://raw.githubusercontent.com/coolsnowwolf/lede/master/package/network/utils/iptables/patches/900-bcm-fullconenat.patch" \
          "package/network/utils/iptables/patches/900-bcm-fullconenat.patch"
        
        # 6. ä¸‹è½½ä¼ ç»Ÿ firewall3 Fullcone æ”¯æŒ
        echo "ä¸‹è½½ä¼ ç»Ÿ firewall3 Fullcone æ”¯æŒ..."
        download_with_retry \
          "https://raw.githubusercontent.com/coolsnowwolf/lede/master/package/network/config/firewall/patches/100-fullconenat.patch" \
          "package/network/config/firewall/patches/100-fullconenat.patch"
        
        download_with_retry \
          "https://raw.githubusercontent.com/coolsnowwolf/lede/master/package/network/config/firewall/patches/101-bcm-fullconenat.patch" \
          "package/network/config/firewall/patches/101-bcm-fullconenat.patch"
        
        # 7. ä¸‹è½½ nftables Fullcone å†…æ ¸æ¨¡å—
        echo "ä¸‹è½½ nftables Fullcone å†…æ ¸æ¨¡å—..."
        download_with_retry \
          "https://raw.githubusercontent.com/coolsnowwolf/lede/master/package/network/services/fullconenat-nft/Makefile" \
          "package/network/services/fullconenat-nft/Makefile"
        
        # 8. ä¸‹è½½ä¼ ç»Ÿ iptables Fullcone å†…æ ¸æ¨¡å—
        echo "ä¸‹è½½ä¼ ç»Ÿ iptables Fullcone å†…æ ¸æ¨¡å—..."
        download_with_retry \
          "https://raw.githubusercontent.com/coolsnowwolf/lede/master/package/network/services/fullconenat/Makefile" \
          "package/network/services/fullconenat/Makefile"
        
        download_with_retry \
          "https://raw.githubusercontent.com/coolsnowwolf/lede/master/package/network/services/fullconenat/src/Makefile" \
          "package/network/services/fullconenat/src/Makefile"
        
        echo "âœ… Fullcone NAT ç»„ä»¶ä¸‹è½½å®Œæˆ"
        
        # éªŒè¯å…³é”®æ–‡ä»¶
        echo "=== éªŒè¯å…³é”®æ–‡ä»¶ ==="
        critical_files=(
          "target/linux/generic/hack-6.12/982-add-bcm-fullconenat-support.patch"
          "package/network/utils/nftables/patches/002-nftables-add-fullcone-expression-support.patch"
          "package/network/config/firewall4/patches/001-firewall4-add-support-for-fullcone-nat.patch"
        )
        
        for file in "${critical_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… å…³é”®æ–‡ä»¶å­˜åœ¨: $(basename $file)"
          else
            echo "âŒ å…³é”®æ–‡ä»¶ç¼ºå¤±: $(basename $file)"
          fi
        done
        
    - name: è¿è¡Œ prereq æ£€æŸ¥
      run: |
        echo "=== è¿è¡Œ prereq ä¾èµ–æ£€æŸ¥ ==="
        make prereq
        echo "âœ… prereq æ£€æŸ¥é€šè¿‡"

    - name: åº”ç”¨åŸºç¡€é…ç½®
      run: |
        echo "=== åº”ç”¨åŸºç¡€è®¾å¤‡é…ç½® ==="
        if [ "${{ github.event.inputs.target_device }}" = "nanopi-r3s" ]; then
          cp configs/nanopi-r3s.config .config
          echo "é€‰æ‹© NanoPi R3S é…ç½®"
        else
          cp configs/nanopi-r6s.config .config
          echo "é€‰æ‹© NanoPi R6S é…ç½®"
        fi
        
        # åº”ç”¨åŸºç¡€é…ç½®
        make defconfig
        echo "âœ… åŸºç¡€é…ç½®å®Œæˆ"

    - name: é…ç½®å®Œæ•´çš„ Fullcone NAT åŠŸèƒ½
      run: |
        echo "=== é…ç½®å®Œæ•´çš„ LEDE Fullcone NAT åŠŸèƒ½ ==="
        
        # å¯ç”¨å…¨å†…æ ¸æ¨¡å—
        echo "CONFIG_ALL_KMODS=y" >> .config
        
        # åŸºç¡€ç³»ç»Ÿé…ç½®
        echo "CONFIG_USE_APK=y" >> .config
        
        # ç¦ç”¨æœ‰é—®é¢˜çš„åŒ…
        echo "# CONFIG_PACKAGE_rtpengine is not set" >> .config
        echo "# CONFIG_PACKAGE_freeswitch is not set" >> .config
        echo "# CONFIG_PACKAGE_asterisk is not set" >> .config
        
        # Fullcone NAT - å®Œæ•´ LEDE æ–¹æ¡ˆ
        echo "CONFIG_PACKAGE_firewall4=y" >> .config
        echo "CONFIG_PACKAGE_nftables-json=y" >> .config
        echo "CONFIG_PACKAGE_kmod-nft-fullcone=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-fullconenat=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-fullconenat=y" >> .config
        
        # å¯ç”¨ BCM Fullcone æ”¯æŒ
        echo "CONFIG_PACKAGE_kmod-nft-nat=y" >> .config
        echo "CONFIG_PACKAGE_kmod-nf-conntrack=y" >> .config
        echo "CONFIG_PACKAGE_kmod-nf-nat=y" >> .config
        
        # Shortcut FEé…ç½®
        if [ "${{ github.event.inputs.include_sfe }}" = "true" ]; then
          echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
          echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
          echo "CONFIG_PACKAGE_kmod-shortcut-fe-drv=y" >> .config
        fi
        
        # æ ¹æ®ç¼–è¯‘æ¨¡å¼é…ç½®
        if [ "${{ github.event.inputs.build_mode }}" = "full" ]; then
          echo "CONFIG_PACKAGE_bash=y" >> .config
          echo "CONFIG_PACKAGE_htop=y" >> .config
          echo "CONFIG_PACKAGE_nano=y" >> .config
          echo "CONFIG_PACKAGE_vim=y" >> .config
          echo "CONFIG_PACKAGE_curl=y" >> .config
        fi
        
        # iStoreé…ç½®
        if [ "${{ github.event.inputs.include_istore }}" = "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-istorex=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-store=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-quickstart=y" >> .config
        fi
        
        # é‡æ–°åº”ç”¨é…ç½®
        make defconfig
        echo "âœ… å®Œæ•´çš„ Fullcone NAT é…ç½®å®Œæˆ"

    - name: å¯ç”¨å¿…éœ€çš„å†…æ ¸æ¨¡å—
      run: |
        echo "=== å¯ç”¨å¿…éœ€çš„å†…æ ¸æ¨¡å— ==="
        
        # ç½‘ç»œæ ¸å¿ƒæ¨¡å—
        echo "CONFIG_PACKAGE_kmod-ppp=y" >> .config
        echo "CONFIG_PACKAGE_kmod-pppoe=y" >> .config
        echo "CONFIG_PACKAGE_kmod-nf-nat=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipv6=y" >> .config
        
        # Fullcone NAT ä¾èµ–æ¨¡å—
        echo "CONFIG_PACKAGE_kmod-nf-conntrack=y" >> .config
        echo "CONFIG_PACKAGE_kmod-nf-conntrack-netlink=y" >> .config
        echo "CONFIG_PACKAGE_kmod-nf-nat=y" >> .config
        
        # æ–‡ä»¶ç³»ç»Ÿ
        echo "CONFIG_PACKAGE_kmod-fs-ext4=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-squashfs=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-vfat=y" >> .config
        
        # USBæ”¯æŒ
        echo "CONFIG_PACKAGE_kmod-usb-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-storage=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
        
        # åŠ å¯†
        echo "CONFIG_PACKAGE_kmod-crypto-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-crypto-hash=y" >> .config
        
        # å…¶ä»–æ ¸å¿ƒæ¨¡å—
        echo "CONFIG_PACKAGE_kmod-nls-base=y" >> .config
        echo "CONFIG_PACKAGE_kmod-nls-utf8=y" >> .config
        
        # åº”ç”¨é…ç½®
        make oldconfig
        echo "âœ… å†…æ ¸æ¨¡å—é…ç½®å®Œæˆ"

    - name: éªŒè¯å®Œæ•´çš„ Fullcone NAT é…ç½®
      run: |
        echo "=== éªŒè¯å®Œæ•´çš„ LEDE Fullcone NAT é…ç½® ==="
        
        echo "Fullcone NAT ç»„ä»¶çŠ¶æ€:"
        components=(
          "target/linux/generic/hack-6.12/982-add-bcm-fullconenat-support.patch"
          "package/libs/libnftnl/patches/001-libnftnl-add-fullcone-expression-support.patch"
          "package/network/utils/nftables/patches/002-nftables-add-fullcone-expression-support.patch"
          "package/network/config/firewall4/patches/001-firewall4-add-support-for-fullcone-nat.patch"
          "package/network/utils/iptables/patches/900-bcm-fullconenat.patch"
          "package/network/config/firewall/patches/100-fullconenat.patch"
          "package/network/config/firewall/patches/101-bcm-fullconenat.patch"
          "package/network/services/fullconenat-nft/Makefile"
          "package/network/services/fullconenat/Makefile"
        )
        
        for comp in "${components[@]}"; do
          if [ -f "$comp" ]; then
            echo "âœ… $(basename $comp)"
          else
            echo "âŒ $(basename $comp) ç¼ºå¤±"
          fi
        done
        
        echo ""
        echo "Fullcone NAT é…ç½®çŠ¶æ€:"
        echo "BCM å†…æ ¸è¡¥ä¸: $(grep "CONFIG_PACKAGE_kmod-nft-fullcone" .config || echo "æœªé…ç½®")"
        echo "nftables Fullcone: $(grep "CONFIG_PACKAGE_nftables" .config || echo "æœªé…ç½®")"
        echo "iptables Fullcone: $(grep "CONFIG_PACKAGE_iptables-mod-fullconenat" .config || echo "æœªé…ç½®")"
        echo "firewall4: $(grep "CONFIG_PACKAGE_firewall4" .config || echo "æœªé…ç½®")"
        
        echo ""
        echo "ğŸ¯ LEDE Fullcone NAT æŠ€æœ¯æ ˆ:"
        echo "  - BCM å†…æ ¸çº§ Fullcone NAT (æœ€é«˜æ€§èƒ½)"
        echo "  - nftables fullcone è¡¨è¾¾å¼æ”¯æŒ"
        echo "  - iptables FULLCONENAT ä¼ ç»Ÿæ”¯æŒ"
        echo "  - åŒé‡é˜²ç«å¢™æ”¯æŒ (firewall3 + firewall4)"
        echo "  - å®Œæ•´çš„å†…æ ¸æ¨¡å—ç”Ÿæ€"

    - name: ä¿®å¤å¸¸è§é—®é¢˜
      run: |
        echo "=== ä¿®å¤å¸¸è§ç¼–è¯‘é—®é¢˜ ==="
        
        # æ¸…ç†æœ‰é—®é¢˜çš„åŒ…
        rm -rf feeds/telephony/net/rtpengine 2>/dev/null || true
        
        # ä¿®å¤å¯èƒ½çš„ä¾èµ–é—®é¢˜
        if [ -d "package/qca/shortcut-fe" ]; then
          echo "ä¿®å¤ Shortcut FE é…ç½®..."
          find package/qca/shortcut-fe -name "*.mk" -exec sed -i 's/kmod-shortcut-fe-cm/kmod-shortcut-fe/g' {} \; 2>/dev/null || true
        fi

    - name: ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
      run: |
        echo "=== ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯ ==="
        {
          echo "å›ºä»¶ç‰ˆæœ¬: OpenWrt SNAPSHOT (å®Œæ•´ LEDE Fullcone NAT æ”¯æŒ)"
          echo "å†…æ ¸ç‰ˆæœ¬: 6.6 (å¸¦ BCM Fullcone è¡¥ä¸)"
          echo "ç¼–è¯‘æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ç›®æ ‡è®¾å¤‡: ${{ github.event.inputs.target_device }}"
          echo "ç¼–è¯‘æ¨¡å¼: ${{ github.event.inputs.build_mode }}"
          echo ""
          echo "ğŸ¯ Fullcone NAT æŠ€æœ¯ç‰¹æ€§:"
          echo "  - BCM Fullcone NAT å†…æ ¸è¡¥ä¸ (æœ€é«˜æ€§èƒ½)"
          echo "  - nftables fullcone ç‹¬ç«‹è¡¨è¾¾å¼"
          echo "  - iptables FULLCONENAT ä¼ ç»Ÿç›®æ ‡"
          echo "  - åŒé‡é˜²ç«å¢™æ”¯æŒ"
          echo "  - å®Œæ•´å†…æ ¸æ¨¡å—ç”Ÿæ€"
          echo ""
          echo "åŒ…å«åŠŸèƒ½:"
          echo "  - å…¨å†…æ ¸æ¨¡å—æ”¯æŒ"
          echo "  - å®Œæ•´ Fullcone NAT æŠ€æœ¯æ ˆ"
          echo "  - firewall4 + nftables (ç°ä»£)"
          echo "  - firewall3 + iptables (ä¼ ç»Ÿ)"
          
          if [ "${{ github.event.inputs.include_sfe }}" = "true" ]; then
            echo "  - Shortcut FE åŠ é€Ÿ"
          else
            echo "  - æ—  SFE åŠ é€Ÿ"
          fi
          
          if [ "${{ github.event.inputs.include_istore }}" = "true" ]; then
            echo "  - iStore åº”ç”¨å•†åº—"
          else
            echo "  - æ—  iStore"
          fi
          
          echo "Gitæäº¤: $(git log -1 --format=%h)"
        } > version-info.txt
        
        cat version-info.txt

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        echo "=== å¼€å§‹ç¼–è¯‘ï¼ˆå®Œæ•´ LEDE Fullcone NAT æ”¯æŒï¼‰==="
        
        # è®¾ç½®çº¿ç¨‹æ•°
        if [ "${{ github.event.inputs.compile_threads }}" = "multi" ]; then
          THREADS=$(nproc)
          echo "ä½¿ç”¨å¤šçº¿ç¨‹æ¨¡å¼: $THREADS ä¸ªCPUæ ¸å¿ƒ"
        else
          THREADS=1
          echo "ä½¿ç”¨å•çº¿ç¨‹æ¨¡å¼: 1 ä¸ªCPUæ ¸å¿ƒ (ç³»ç»Ÿæœ‰ $(nproc) ä¸ªæ ¸å¿ƒ)"
        fi
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export FORCE_UNSAFE_CONFIGURE=1
        
        echo "å¼€å§‹å®Œæ•´ç¼–è¯‘..."
        set +e  # ç¦ç”¨é”™è¯¯é€€å‡º
        if [ "$THREADS" -eq 1 ]; then
          make -j1 V=s 2>&1 | tee build.log
          COMPILE_RESULT=${PIPESTATUS[0]}
        else
          make -j$THREADS V=s 2>&1 | tee build.log
          COMPILE_RESULT=${PIPESTATUS[0]}
        fi
        set -e  # é‡æ–°å¯ç”¨é”™è¯¯é€€å‡º
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        if [ -d "bin/targets" ] && [ $(find bin/targets/ -name "*.bin" -o -name "*.img" 2>/dev/null | wc -l) -gt 0 ]; then
          echo "âœ… å›ºä»¶æ–‡ä»¶å·²ç”Ÿæˆï¼Œç¼–è¯‘æˆåŠŸ"
          exit 0
        elif [ -d "bin/packages" ] && [ $(find bin/packages/ -name "*.apk" 2>/dev/null | wc -l) -gt 0 ]; then
          echo "âš ï¸ åªæœ‰è½¯ä»¶åŒ…ç”Ÿæˆï¼Œç¼–è¯‘éƒ¨åˆ†æˆåŠŸ"
          exit 0
        elif [ $COMPILE_RESULT -eq 0 ]; then
          echo "âœ… ç¼–è¯‘è¿‡ç¨‹å®Œæˆï¼ˆæ— é”™è¯¯ï¼‰"
          exit 0
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          exit $COMPILE_RESULT
        fi

    - name: æ”¶é›†æ„å»ºäº§ç‰©
      if: always()
      run: |
        echo "=== æ”¶é›†æ„å»ºäº§ç‰© ==="
        mkdir -p upload/firmware upload/packages upload/logs
        
        # æ”¶é›†å›ºä»¶
        find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \) -exec cp --parents {} upload/firmware/ \; 2>/dev/null || true
        
        # æ”¶é›†è½¯ä»¶åŒ…
        if [ -d "bin/packages" ]; then
          cp -r bin/packages/* upload/packages/ 2>/dev/null || true
        fi
        
        # æ”¶é›†æ—¥å¿—å’Œé…ç½®
        cp version-info.txt upload/ 2>/dev/null || true
        cp .config upload/ 2>/dev/null || true
        cp build.log upload/logs/ 2>/dev/null || true
        
        echo "äº§ç‰©ç»Ÿè®¡:"
        echo "å›ºä»¶æ–‡ä»¶: $(find upload/firmware -type f 2>/dev/null | wc -l || echo 0) ä¸ª"
        echo "è½¯ä»¶åŒ…: $(find upload/packages -name "*.apk" 2>/dev/null | wc -l || echo 0) ä¸ª"
        find upload/firmware -type f 2>/dev/null | head -10 || echo "æ— å›ºä»¶æ–‡ä»¶"

    - name: ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.target_device }}-${{ github.event.inputs.build_mode }}
        path: upload/firmware/
        retention-days: 30
        if-no-files-found: warn

    - name: ä¸Šä¼ è½¯ä»¶åŒ…
      uses: actions/upload-artifact@v4
      with:
        name: packages-${{ github.event.inputs.target_device }}-${{ github.event.inputs.build_mode }}
        path: upload/packages/
        retention-days: 30
        if-no-files-found: warn

    - name: ä¸Šä¼ æ„å»ºä¿¡æ¯
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-info-${{ github.event.inputs.target_device }}-${{ github.event.inputs.build_mode }}
        path: upload/
        retention-days: 7
        if-no-files-found: warn
