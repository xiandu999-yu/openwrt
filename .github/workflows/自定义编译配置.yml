name: 自定义编译配置

on:
  schedule:
    - cron: '0 4 * * *'  # 每天UTC时间4点编译
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      target_device:  # 目标设备
        description: '选择编译目标设备'
        required: true
        default: 'nanopi-r3s'
        type: choice
        options:
          - nanopi-r3s
          - nanopi-r6s
      include_sfe:  # 包含SFE加速
        description: '是否包含Shortcut FE加速'
        type: boolean
        required: false
        default: true
      compile_threads:  # 编译线程数
        description: '选择编译线程数 (单线程更稳定，多线程更快)'
        required: false
        default: 'single'
        type: choice
        options:
          - single
          - multi
      build_mode:  # 编译模式
        description: '选择编译模式 (firmware=全kmods+固件, full=全kmods+固件+全插件)'
        required: false
        default: 'firmware'
        type: choice
        options:
          - firmware
          - full
      include_istore:  # 包含iStore
        description: '是否包含iStore相关功能'
        type: boolean
        required: false
        default: true

env:
  TIMEOUT: 360m

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: 设置构建缓存
      uses: actions/cache@v3
      with:
        path: |
          dl
          build_dir
          staging_dir
          tmp
          .config
          feeds
        key: ${{ runner.os }}-openwrt-${{ hashFiles('configs/*.config', 'feeds.conf', '.config') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-

    - name: 安装系统依赖 (LEDE推荐)
      run: |
        echo "=== 安装LEDE推荐的完整编译依赖 ==="
        sudo apt update -y
        sudo apt full-upgrade -y
        sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext \
        genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
        libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
        libreadline-dev libssl-dev libtool llvm lrzsz libnsl-dev ninja-build p7zip p7zip-full patch pkgconf \
        python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
        swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev

    - name: 检查系统信息
      run: |
        echo "=== 环境信息 ==="
        echo "设备: ${{ github.event.inputs.target_device }}"
        echo "线程: ${{ github.event.inputs.compile_threads }}"
        echo "模式: ${{ github.event.inputs.build_mode }}"
        echo "iStore: ${{ github.event.inputs.include_istore }}"
        echo "SFE: ${{ github.event.inputs.include_sfe }}"
        echo "CPU: $(nproc) 核心"
        echo "内存: $(free -h | grep Mem | awk '{print $2}')"
        echo "系统: $(lsb_release -d | cut -f2)"
        echo ""

    - name: 配置 feeds 源
      run: |
        echo "配置 feeds 源..."
        cat > feeds.conf << 'EOF'
        src-git packages https://github.com/openwrt/packages.git
        src-git luci https://github.com/openwrt/luci.git
        src-git routing https://github.com/openwrt/routing.git
        src-git telephony https://github.com/openwrt/telephony.git
        EOF

    - name: 更新和安装 feeds
      run: |
        echo "更新 feeds..."
        ./scripts/feeds update -a
        echo "安装 feeds..."
        ./scripts/feeds install -a

    - name: 运行 prereq 检查
      run: |
        echo "=== 运行 prereq 依赖检查 ==="
        make prereq
        echo "✅ prereq 检查通过"

    - name: 应用基础配置
      run: |
        echo "=== 应用基础设备配置 ==="
        if [ "${{ github.event.inputs.target_device }}" = "nanopi-r3s" ]; then
          cp configs/nanopi-r3s.config .config
          echo "选择 NanoPi R3S 配置"
        else
          cp configs/nanopi-r6s.config .config
          echo "选择 NanoPi R6S 配置"
        fi
        
        # 应用基础配置
        make defconfig
        echo "✅ 基础配置完成"

    - name: 检查 TurboACC 包是否存在
      run: |
        echo "=== 检查 TurboACC 包是否存在 ==="
        
        echo "搜索 TurboACC 相关文件:"
        find . -name "*turboacc*" -type f 2>/dev/null | head -20 || echo "未找到 turboacc 文件"
        
        echo ""
        echo "搜索 luci-app-turboacc:"
        find . -name "*luci-app-turboacc*" -type d 2>/dev/null | head -10 || echo "未找到 luci-app-turboacc 目录"
        
        echo ""
        echo "搜索 feeds 中的 TurboACC:"
        find feeds -name "*turboacc*" -type d 2>/dev/null | head -10 || echo "feeds 中未找到 turboacc"
        
        echo ""
        echo "检查当前可用的包:"
        ./scripts/feeds list | grep -i turboacc || echo "feeds 列表中无 turboacc"
        ./scripts/feeds list | grep -i fullcone || echo "feeds 列表中无 fullcone"

    - name: 添加 TurboACC 源（如果不存在）
      run: |
        echo "=== 添加 TurboACC 源 ==="
        
        # 检查是否已经存在 turboacc
        if ! find . -name "*turboacc*" -type d | grep -q .; then
          echo "TurboACC 不存在，从官方源添加..."
          # 添加 chenmozhijin 的 turboacc 源
          if ! grep -q "turboacc" feeds.conf; then
            echo "src-git turboacc https://github.com/chenmozhijin/turboacc.git" >> feeds.conf
            echo "✅ 已添加 TurboACC 源"
          fi
          
          # 重新更新 feeds
          ./scripts/feeds update turboacc 2>/dev/null || echo "TurboACC feed 更新失败"
          ./scripts/feeds install -a -p turboacc 2>/dev/null || echo "TurboACC 安装失败"
        else
          echo "✅ TurboACC 已存在"
        fi

    - name: 配置核心功能（安全版本）
      run: |
        echo "=== 配置核心功能（安全版本）==="
        
        # 启用全内核模块
        echo "CONFIG_ALL_KMODS=y" >> .config
        
        # 基础系统配置
        echo "CONFIG_USE_APK=y" >> .config
        
        # 禁用有问题的包
        echo "# CONFIG_PACKAGE_rtpengine is not set" >> .config
        echo "# CONFIG_PACKAGE_freeswitch is not set" >> .config
        echo "# CONFIG_PACKAGE_asterisk is not set" >> .config
        
        # 先检查 TurboACC 是否存在再配置
        if find . -name "*turboacc*" -type d | grep -q . || find feeds -name "*turboacc*" -type d | grep -q .; then
          echo "配置 TurboACC..."
          echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
          echo "CONFIG_PACKAGE_nft-fullcone=y" >> .config
          echo "CONFIG_PACKAGE_kmod-nft-fullcone=y" >> .config
        else
          echo "⚠️ TurboACC 不存在，跳过配置"
        fi
        
        # Shortcut FE配置
        if [ "${{ github.event.inputs.include_sfe }}" = "true" ]; then
          echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
          echo "CONFIG_PACKAGE_kmod-fast-classifier=y" >> .config
          echo "CONFIG_PACKAGE_kmod-shortcut-fe-drv=y" >> .config
        fi
        
        # 根据编译模式配置
        if [ "${{ github.event.inputs.build_mode }}" = "full" ]; then
          echo "CONFIG_PACKAGE_bash=y" >> .config
          echo "CONFIG_PACKAGE_htop=y" >> .config
          echo "CONFIG_PACKAGE_nano=y" >> .config
          echo "CONFIG_PACKAGE_vim=y" >> .config
          echo "CONFIG_PACKAGE_curl=y" >> .config
        fi
        
        # iStore配置
        if [ "${{ github.event.inputs.include_istore }}" = "true" ]; then
          echo "CONFIG_PACKAGE_luci-app-istorex=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-store=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-quickstart=y" >> .config
        fi
        
        # 重新应用配置
        make defconfig
        echo "✅ 核心功能配置完成"

    - name: 启用必需的内核模块
      run: |
        echo "=== 启用必需的内核模块 ==="
        
        # 网络核心模块
        echo "CONFIG_PACKAGE_kmod-ppp=y" >> .config
        echo "CONFIG_PACKAGE_kmod-pppoe=y" >> .config
        echo "CONFIG_PACKAGE_kmod-nf-nat=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipt-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ipv6=y" >> .config
        
        # 文件系统
        echo "CONFIG_PACKAGE_kmod-fs-ext4=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-squashfs=y" >> .config
        echo "CONFIG_PACKAGE_kmod-fs-vfat=y" >> .config
        
        # USB支持
        echo "CONFIG_PACKAGE_kmod-usb-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb-storage=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb2=y" >> .config
        echo "CONFIG_PACKAGE_kmod-usb3=y" >> .config
        
        # 加密
        echo "CONFIG_PACKAGE_kmod-crypto-core=y" >> .config
        echo "CONFIG_PACKAGE_kmod-crypto-hash=y" >> .config
        
        # 其他核心模块
        echo "CONFIG_PACKAGE_kmod-nls-base=y" >> .config
        echo "CONFIG_PACKAGE_kmod-nls-utf8=y" >> .config
        
        # 应用配置
        make oldconfig
        echo "✅ 内核模块配置完成"

    - name: 安全验证配置
      run: |
        echo "=== 安全验证配置 ==="
        
        # 安全的配置检查函数
        safe_check_config() {
            local config=$1
            local description=$2
            if grep -q "^${config}=y" .config 2>/dev/null || grep -q "^${config}=m" .config 2>/dev/null; then
                echo "✅ $description"
                return 0
            else
                echo "❌ $description"
                return 1
            fi
        }
        
        echo "核心功能状态:"
        safe_check_config "CONFIG_ALL_KMODS" "全内核模块"
        safe_check_config "CONFIG_PACKAGE_kmod-ppp" "PPP支持"
        safe_check_config "CONFIG_PACKAGE_kmod-nf-nat" "Netfilter NAT"
        safe_check_config "CONFIG_PACKAGE_kmod-fs-ext4" "EXT4文件系统"
        safe_check_config "CONFIG_PACKAGE_kmod-usb-core" "USB核心"
        
        # 安全检查 TurboACC
        if safe_check_config "CONFIG_PACKAGE_luci-app-turboacc" "TurboACC"; then
          echo "✅ TurboACC 已启用"
        else
          echo "⚠️ TurboACC 未启用（可能包不存在）"
        fi
        
        if [ "${{ github.event.inputs.include_sfe }}" = "true" ]; then
          safe_check_config "CONFIG_PACKAGE_kmod-shortcut-fe" "Shortcut FE"
        fi
        
        if [ "${{ github.event.inputs.include_istore }}" = "true" ]; then
          safe_check_config "CONFIG_PACKAGE_luci-app-istorex" "iStore"
        fi
        
        echo ""
        echo "配置统计:"
        echo "总配置项: $(grep -c "^CONFIG_" .config 2>/dev/null || echo 0)"
        echo "编译进内核: $(grep "^CONFIG_.*=y" .config 2>/dev/null | wc -l)"
        echo "编译为模块: $(grep "^CONFIG_.*=m" .config 2>/dev/null | wc -l)"

    - name: 修复常见问题
      run: |
        echo "=== 修复常见编译问题 ==="
        
        # 清理有问题的包
        rm -rf feeds/telephony/net/rtpengine 2>/dev/null || true
        
        # 修复可能的依赖问题
        if [ -d "package/qca/shortcut-fe" ]; then
          echo "修复 Shortcut FE 配置..."
          find package/qca/shortcut-fe -name "*.mk" -exec sed -i 's/kmod-shortcut-fe-cm/kmod-shortcut-fe/g' {} \; 2>/dev/null || true
        fi

    - name: 生成版本信息
      run: |
        echo "=== 生成版本信息 ==="
        {
          echo "固件版本: OpenWrt SNAPSHOT"
          echo "内核版本: 6.12"
          echo "编译时间: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "目标设备: ${{ github.event.inputs.target_device }}"
          echo "编译模式: ${{ github.event.inputs.build_mode }}"
          echo "包含功能:"
          echo "  - 全内核模块"
          echo "  - Fullcone NAT"
          
          if [ "${{ github.event.inputs.include_sfe }}" = "true" ]; then
            echo "  - Shortcut FE加速"
          else
            echo "  - 无SFE加速"
          fi
          
          if [ "${{ github.event.inputs.include_istore }}" = "true" ]; then
            echo "  - iStore应用商店"
          else
            echo "  - 无iStore"
          fi
          
          echo "Git提交: $(git log -1 --format=%h)"
        } > version-info.txt
        
        cat version-info.txt

    - name: 编译固件
      run: |
        echo "=== 开始编译 ==="
        
        # 设置线程数
        if [ "${{ github.event.inputs.compile_threads }}" = "multi" ]; then
          THREADS=$(nproc)
          echo "使用多线程模式: $THREADS 个CPU核心"
        else
          THREADS=1
          echo "使用单线程模式: 1 个CPU核心 (系统有 $(nproc) 个核心)"
        fi
        
        # 设置环境变量
        export FORCE_UNSAFE_CONFIGURE=1
        
        echo "开始完整编译..."
        set +e  # 禁用错误退出
        if [ "$THREADS" -eq 1 ]; then
          make -j1 V=s 2>&1 | tee build.log
          COMPILE_RESULT=${PIPESTATUS[0]}
        else
          make -j$THREADS V=s 2>&1 | tee build.log
          COMPILE_RESULT=${PIPESTATUS[0]}
        fi
        set -e  # 重新启用错误退出
        
        # 检查是否有产物生成
        if [ -d "bin/targets" ] && [ $(find bin/targets/ -name "*.bin" -o -name "*.img" 2>/dev/null | wc -l) -gt 0 ]; then
          echo "✅ 固件文件已生成，编译成功"
          exit 0
        elif [ -d "bin/packages" ] && [ $(find bin/packages/ -name "*.ipk" 2>/dev/null | wc -l) -gt 0 ]; then
          echo "⚠️ 只有软件包生成，编译部分成功"
          exit 0
        elif [ $COMPILE_RESULT -eq 0 ]; then
          echo "✅ 编译过程完成（无错误）"
          exit 0
        else
          echo "❌ 编译失败"
          exit $COMPILE_RESULT
        fi

    - name: 收集构建产物
      if: always()
      run: |
        echo "=== 收集构建产物 ==="
        mkdir -p upload/firmware upload/packages upload/logs
        
        # 收集固件
        find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \) -exec cp --parents {} upload/firmware/ \; 2>/dev/null || true
        
        # 收集软件包
        if [ -d "bin/packages" ]; then
          cp -r bin/packages/* upload/packages/ 2>/dev/null || true
        fi
        
        # 收集日志和配置
        cp version-info.txt upload/ 2>/dev/null || true
        cp .config upload/ 2>/dev/null || true
        cp build.log upload/logs/ 2>/dev/null || true
        
        echo "产物统计:"
        echo "固件文件: $(find upload/firmware -type f 2>/dev/null | wc -l || echo 0) 个"
        echo "软件包: $(find upload/packages -name "*.apk" 2>/dev/null | wc -l || echo 0) 个"
        find upload/firmware -type f 2>/dev/null | head -10 || echo "无固件文件"

    - name: 上传固件
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.target_device }}-${{ github.event.inputs.build_mode }}
        path: upload/firmware/
        retention-days: 30
        if-no-files-found: warn

    - name: 上传软件包
      uses: actions/upload-artifact@v4
      with:
        name: packages-${{ github.event.inputs.target_device }}-${{ github.event.inputs.build_mode }}
        path: upload/packages/
        retention-days: 30
        if-no-files-found: warn

    - name: 上传构建信息
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-info-${{ github.event.inputs.target_device }}-${{ github.event.inputs.build_mode }}
        path: upload/
        retention-days: 7
        if-no-files-found: warn
