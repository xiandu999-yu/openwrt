name: 自定义编译配置

on:
  schedule:
    - cron: '0 4 * * *'  # 每天UTC时间4点编译
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      target:
        description: 'Build target (nanopi-r3s or nanopi-r6s)'
        required: true
        default: 'nanopi-r3s'
        type: choice
        options:
          - nanopi-r3s
          - nanopi-r6s
      include_sfe:
        description: 'Include Shortcut FE acceleration'
        type: boolean
        required: false
        default: false

env:
  TIMEOUT: 240m

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 240  # 4小时超时
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          g++-multilib \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-pip \
          python3-setuptools \
          python3-dev \
          python3-serial \
          unzip \
          zlib1g-dev \
          file \
          wget \
          rsync \
          swig \
          libelf-dev

    - name: Install Python dependencies
      run: |
        python3 -m pip install --upgrade pip
        python3 -m pip install \
          pyelftools \
          cffi \
          scapy \
          requests \
          pycrypto \
          pycryptodome
        
        # 验证安装
        python3 -c "import elftools; print('elftools version:', elftools.__version__)" || echo "elftools installed"
        python3 -c "import cffi; print('cffi installed')"

    - name: Apply custom modifications
      run: |
        chmod +x scripts/*.sh
        echo "应用基础补丁..."
        ./scripts/apply-custom-patches.sh
        
        echo "集成TurboACC功能..."
        if [ "${{ github.event.inputs.include_sfe }}" = "true" ]; then
          echo "包含SFE加速"
          ./scripts/integrate-features.sh --with-sfe
        else
          echo "仅Fullcone NAT"
          ./scripts/integrate-features.sh
        fi
        
        echo "添加软件包..."
        ./scripts/add-packages.sh

    - name: Update feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Check prerequisites
      run: |
        echo "检查构建前提条件..."
        make toolchain/install
        make package/compile
        make target/compile
        echo "✅ 前提条件检查通过"

    - name: Configure build
      run: |
        # 复制基础配置
        if [ "${{ github.event.inputs.target }}" = "nanopi-r3s" ]; then
          cp configs/nanopi-r3s.config .config
          echo "选择NanoPi R3S配置"
        else
          cp configs/nanopi-r6s.config .config
          echo "选择NanoPi R6S配置"
        fi
        
        # 根据参数调整配置
        if [ "${{ github.event.inputs.include_sfe }}" = "true" ]; then
          echo "启用Shortcut FE..."
          echo "CONFIG_PACKAGE_kmod-shortcut-fe=y" >> .config
          echo "CONFIG_PACKAGE_kmod-shortcut-fe-cm=y" >> .config
        fi
        
        # 启用TurboACC
        echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
        echo "CONFIG_PACKAGE_nft-fullcone=y" >> .config
        
        make defconfig

    - name: Download packages
      run: |
        echo "开始下载包..."
        make download -j8
        echo "下载完成"
        find dl -size +5M -exec ls -lh {} \; | head -10

    - name: Build firmware
      run: |
        echo "开始编译固件..."
        # 先编译工具链和基础包
        make tools/install -j$(nproc)
        make toolchain/install -j$(nproc)
        
        # 然后编译完整固件
        make -j$(($(nproc) + 1)) V=sc 2>&1 | tee build.log

    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-${{ github.event.inputs.target }}-${{ github.event.inputs.include_sfe && 'sfe' || 'nosfe' }}
        path: bin/targets/
        retention-days: 30

    - name: Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.event.inputs.target }}
        path: build.log
        retention-days: 7
